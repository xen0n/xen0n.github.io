<!doctype html><html lang=zh-cmn-hans-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>è·Ÿ ujson ç©ç¬¦å·æ‰è¿·è— | write(2)</title>
<meta name=keywords content><meta name=description content="tl;dr Python çš„ é«˜æ€§èƒ½ JSON åº“ ujson æˆªè‡³ç›®å‰åœ¨ Gentoo (GCC 5.3.0) ä¸ FreeBSD 10 ä¸Šä½¿ç”¨æ—¶éƒ½å¯èƒ½ç¢°åˆ° ImportError é”™è¯¯. è¯¥é”™è¯¯çš„ä¿®å¤è¡¥ä¸å·²ç»æäº¤ä¸Šæ¸¸, ä¼°è®¡è¿‡ä¸€é˜µå­å°±èƒ½ç”¨ä¸Šäº†! é—®é¢˜ é«˜é«˜å…´å…´åœ°å¼€äº†ä¸€"><meta name=author content="WÃNG &#34;xen0n&#34; XuÄ›ruÃ¬"><link rel=canonical href=https://blog.xen0n.name/posts/tinkering/ujson-symbol-chasing/><link crossorigin=anonymous href=/assets/css/stylesheet.41f810764fcdd619307656c791833b60b7b03fee6398926d0dd5336d9ffbf77d.css integrity="sha256-QfgQdk/N1hkwdlbHkYM7YLewP+5jmJJtDdUzbZ/7930=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.xen0n.name/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.xen0n.name/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.xen0n.name/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.xen0n.name/apple-touch-icon.png><link rel=mask-icon href=https://blog.xen0n.name/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cmn-hans-cn href=https://blog.xen0n.name/posts/tinkering/ujson-symbol-chasing/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="è·Ÿ ujson ç©ç¬¦å·æ‰è¿·è—"><meta property="og:description" content="tl;dr Python çš„ é«˜æ€§èƒ½ JSON åº“ ujson æˆªè‡³ç›®å‰åœ¨ Gentoo (GCC 5.3.0) ä¸ FreeBSD 10 ä¸Šä½¿ç”¨æ—¶éƒ½å¯èƒ½ç¢°åˆ° ImportError é”™è¯¯. è¯¥é”™è¯¯çš„ä¿®å¤è¡¥ä¸å·²ç»æäº¤ä¸Šæ¸¸, ä¼°è®¡è¿‡ä¸€é˜µå­å°±èƒ½ç”¨ä¸Šäº†! é—®é¢˜ é«˜é«˜å…´å…´åœ°å¼€äº†ä¸€"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.xen0n.name/posts/tinkering/ujson-symbol-chasing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-05-30T19:16:51+08:00"><meta property="article:modified_time" content="2016-05-30T19:16:51+08:00"><meta property="og:site_name" content="write(2)"><meta name=twitter:card content="summary"><meta name=twitter:title content="è·Ÿ ujson ç©ç¬¦å·æ‰è¿·è—"><meta name=twitter:description content="tl;dr Python çš„ é«˜æ€§èƒ½ JSON åº“ ujson æˆªè‡³ç›®å‰åœ¨ Gentoo (GCC 5.3.0) ä¸ FreeBSD 10 ä¸Šä½¿ç”¨æ—¶éƒ½å¯èƒ½ç¢°åˆ° ImportError é”™è¯¯. è¯¥é”™è¯¯çš„ä¿®å¤è¡¥ä¸å·²ç»æäº¤ä¸Šæ¸¸, ä¼°è®¡è¿‡ä¸€é˜µå­å°±èƒ½ç”¨ä¸Šäº†! é—®é¢˜ é«˜é«˜å…´å…´åœ°å¼€äº†ä¸€"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.xen0n.name/posts/"},{"@type":"ListItem","position":2,"name":"è·Ÿ ujson ç©ç¬¦å·æ‰è¿·è—","item":"https://blog.xen0n.name/posts/tinkering/ujson-symbol-chasing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"è·Ÿ ujson ç©ç¬¦å·æ‰è¿·è—","name":"è·Ÿ ujson ç©ç¬¦å·æ‰è¿·è—","description":"tl;dr Python çš„ é«˜æ€§èƒ½ JSON åº“ ujson æˆªè‡³ç›®å‰åœ¨ Gentoo (GCC 5.3.0) ä¸ FreeBSD 10 ä¸Šä½¿ç”¨æ—¶éƒ½å¯èƒ½ç¢°åˆ° ImportError é”™è¯¯. è¯¥é”™è¯¯çš„ä¿®å¤è¡¥ä¸å·²ç»æäº¤ä¸Šæ¸¸, ä¼°è®¡è¿‡ä¸€é˜µå­å°±èƒ½ç”¨ä¸Šäº†! é—®é¢˜ é«˜é«˜å…´å…´åœ°å¼€äº†ä¸€","keywords":[],"articleBody":"tl;dr Python çš„ é«˜æ€§èƒ½ JSON åº“ ujson æˆªè‡³ç›®å‰åœ¨ Gentoo (GCC 5.3.0) ä¸ FreeBSD 10 ä¸Šä½¿ç”¨æ—¶éƒ½å¯èƒ½ç¢°åˆ° ImportError é”™è¯¯. è¯¥é”™è¯¯çš„ä¿®å¤è¡¥ä¸å·²ç»æäº¤ä¸Šæ¸¸, ä¼°è®¡è¿‡ä¸€é˜µå­å°±èƒ½ç”¨ä¸Šäº†!\né—®é¢˜ é«˜é«˜å…´å…´åœ°å¼€äº†ä¸€ä¸ªæ–°å‘, åˆå§‹åŒ–äº†è™šæ‹Ÿç¯å¢ƒ, å› ä¸ºé©¬ä¸Šè¦å¤„ç†ä¸€ä¸ªå·¨å¤§çš„ JSON æ‰€ä»¥è£…ä¸Šäº† ujson. å¼€å§‹å¹²æ´»!\nIn [1]: import ujson --------------------------------------------------------------------------- ImportError Traceback (most recent call last) in () ----\u003e 1 import ujson ImportError: /.../ujson.so: undefined symbol: Buffer_AppendShortHexUnchecked (æ–‡ä»¶è·¯å¾„å¾ˆé•¿, ç¼–è¾‘æ‰äº†å¤§éƒ¨åˆ†)\nè§£å†³ è¿™æ˜¯ä»€ä¹ˆæƒ…å†µ? æœç´¢äº†ä¸€åœˆ, æœç„¶æˆ‘ä¸æ˜¯ä¸€ä¸ªäºº, ä¸è¿‡çœ‹èµ·æ¥åº”è¯¥æŒºç®€å•çš„æ ·å­å› ä¸º Gentoo é‚®ä»¶åˆ—è¡¨çš„é‚£ä¸ªäººæœºå™¨ä¸Šè™šæ‹Ÿç¯å¢ƒå¤–çš„å®‰è£…æ˜¯æ­£å¸¸çš„?! å†åŠ ä¸Šè¿™ä¸ªé—®é¢˜ä¹‹å‰æˆ‘åœ¨å¾ˆå¤š Gentoo ç³»ç»Ÿä¸Šä¹Ÿä»æ¥æ²¡æœ‰é‡åˆ°, è¿™å°±è¯´æ˜é—®é¢˜åº”è¯¥å±€é™åœ¨ Python åŒ…é‡Œé¢, è€Œä¸”è·Ÿå…·ä½“ç³»ç»Ÿé…ç½®åº”è¯¥ä¹Ÿæœ‰å…³ç³».\nå› ä¸º ujson æ˜¯ä¸€ä¸ªçº¯ C å†™æˆçš„ Python æ‰©å±•, æœ¬èº«ä¹Ÿæ”¯æŒ Python 3 (æˆ‘ä½¿ç”¨çš„æ˜¯ Python 3.5 åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ), æ‰€ä»¥é—®é¢˜åº”è¯¥è·Ÿ Python çš„ ABI æ— å…³. ç»è¿‡ç®€å•çš„ç½‘ç»œæœç´¢å’Œ grep, å‡ºé—®é¢˜çš„å‡½æ•°æ˜¯ ujson çš„ä¸€ä¸ªå†…éƒ¨ helper å‡½æ•°, è¿™å°± 10000% ç¡®å®šæ˜¯ ujson æœ¬èº«çš„ bug äº†. æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å£°æ˜:\n/* ä¸ºäº†æ¸…æ™°, æ¢è¡Œæ˜¯æˆ‘åŠ çš„ */ FASTCALL_ATTR INLINE_PREFIX void FASTCALL_MSVC Buffer_AppendShortHexUnchecked(char *outputOffset, unsigned short value); è¿˜æœ‰ FreeBSD issue ä¸­æåˆ°çš„ strreverse çš„:\nFASTCALL_ATTR INLINE_PREFIX void FASTCALL_MSVC strreverse(char* begin, char* end); æ‘˜æŠ„ä¸‹è¿™é‡Œçš„å®å®šä¹‰, å¯ä»¥çœ‹åˆ°è¿™äº›å®šä¹‰æ¯”è¾ƒç®€é™‹ (å¹³å°è·Ÿç¼–è¯‘å™¨æ˜¯å¹³è¡Œçš„æ¦‚å¿µ, æ¯”æ–¹è¯´å¹¶ä¸æ˜¯æ‰€æœ‰ Windows ç¨‹åºéƒ½æ˜¯ç”¨ MSVC ç¼–è¯‘çš„, å®Œæ•´æ–‡ä»¶çš„ Windows éƒ¨åˆ†é‡Œè¿˜æœ‰ __declspec(dllexport) è¿™ç§ä¸œè¥¿, è¿™ç§ä»£ç æ”¾åˆ° MinGW GCC ä¸‹å°±è¦ç¼–è¯‘é”™è¯¯äº†), ä¸è¿‡å¹¶ä¸å½±å“é˜…è¯»:\n#ifdef _WIN32 #define FASTCALL_MSVC __fastcall #define FASTCALL_ATTR #define INLINE_PREFIX __inline #else #define FASTCALL_MSVC #if !defined __x86_64__ #define FASTCALL_ATTR __attribute__((fastcall)) #else #define FASTCALL_ATTR #endif #define INLINE_PREFIX inline #endif å…¶ä»–å‡½æ•°çš„å£°æ˜éƒ½æ²¡æœ‰è¿™äº› fastcall å’Œå†…è”çš„æ ‡è®°, å› æ­¤é—®é¢˜å°±å‡ºåœ¨ fastcall æˆ–è€…å†…è”ä¸Š. ä¸è¿‡ fastcall æ˜¯ x86-32 çš„ä¸€ç§è°ƒç”¨çº¦å®š, åœ¨ AMD64 ä¸Šå¹¶ä¸å­˜åœ¨, é‚£ä¹ˆé—®é¢˜åªèƒ½æ˜¯å› ä¸ºå†…è”äº†.\nå„ä½è¿˜è®°å¾— C å†…è”å‡½æ•°ä½¿ç”¨çš„å°ç»†èŠ‚å—? (æ­¤å¤„å¯ä»¥æš‚åœä¸‹æ¥ Google æˆ–è€…ç¿»ä¹¦å“¦)\næ²¡é”™, inline åªæ˜¯ç»™ç¼–è¯‘å™¨çš„å»ºè®®è€Œä¸æ˜¯å‘½ä»¤, åˆ°åº•æ˜¯å¦å†…è”ç¼–è¯‘å™¨å®Œå…¨å¯ä»¥è‡ªè¡Œå†³å®š. ä¸€èˆ¬æƒ…å†µä¸‹ç¼–è¯‘å™¨æ¯”äººè¦èªæ˜, æ‰€ä»¥è¿™æ ·çš„è®¾å®šå¹¶ä¸ä¼šäº§ç”Ÿé—®é¢˜; é—®é¢˜åœ¨äºæœ‰äº›æ—¶å€™äººç±»ç¡®å®æ˜ç™½è‡ªå·±åœ¨åšçš„äº‹æƒ…, å°¤å…¶æ˜¯ç¼–è¯‘å™¨åå¯¹äººçš„æƒ³æ³•ä¹‹åè‡ªå·±åšçš„äº‹æƒ…å´ä¸ä¸€å®šæ­£ç¡® (å› ä¸ºç¼–è¯‘å™¨ä¹Ÿæ˜¯äººå†™çš„, ä¼šæœ‰ bug å•Š)â€¦ å› ä¸ºå¾ˆä¹…ä¹‹å‰å¹¶æ²¡æœ‰è¿™æ ·çš„é—®é¢˜, æœ€è¿‘ä¸¤å¹´ (2015-08 ä¹‹å) æ‰å¼€å§‹å‡ºç°, æ‰€ä»¥ç”¨ç³»ç»Ÿä¸Šçš„ä¸¤ä¸ª gcc ç‰ˆæœ¬æµ‹è¯•äº†ä¸€ä¸‹:\n$ nm ujson.gcc-4.9.3.so | grep 'strreverse\\|Buffer_AppendShortHex' 0000000000007557 T Buffer_AppendShortHexUnchecked 0000000000007557 t Buffer_AppendShortHexUnchecked.localalias.1 000000000000805d T strreverse 000000000000805d t strreverse.localalias.0 $ nm ujson.gcc-5.3.0.so | grep 'strreverse\\|Buffer_AppendShortHex' U Buffer_AppendShortHexUnchecked U strreverse æœç„¶! é‚£æˆ‘ä»¬æŠŠä¸¤ä¸ªå‡½æ•°æ ‡è®°æˆå¼ºåˆ¶å†…è”å°±å¥½äº†:\ndiff --git a/lib/ultrajson.h b/lib/ultrajson.h index 6b1fb85..894f367 100644 --- a/lib/ultrajson.h +++ b/lib/ultrajson.h @@ -115,7 +115,11 @@ typedef uint32_t JSUINT32; #define FASTCALL_ATTR #endif +#ifdef __GNUC__ +#define INLINE_PREFIX __attribute__((always_inline)) inline +#else #define INLINE_PREFIX inline +#endif typedef uint8_t JSUINT8; typedef uint16_t JSUTF16; å› ä¸ºæ²¡æœ‰ç”¨è¿‡åˆ«çš„ç¼–è¯‘å™¨, æ‰€ä»¥æˆ‘åªæ·»åŠ äº† GCC çš„åˆ¤æ–­å’Œç›¸åº”ä»£ç , ä¸è¿‡è‡ªç„¶ä¼šæœ‰äººæ¥æ·»åŠ å…¶ä»–çš„æ‰€ä»¥å°±æ— æ‰€è°“äº†â€¦ æµ‹è¯•ä¸€ä¸‹:\n$ nm ujson.gcc-5.3.0-always_inline.so | grep 'strreverse\\|Buffer_AppendShortHex' $ ä¸¤ä¸ªå‡½æ•°åå·²ç»ä¸å­˜åœ¨äº†, è¿™å¾ˆæ­£å¸¸, å› ä¸ºå®ƒä»¬éƒ½è¢«å†…è”äº†å•Š, import çœ‹çœ‹:\nIn [1]: import ujson In [2]: å¥½!\né™„: ujson ç‰ˆæƒå£°æ˜ æœ¬æ–‡å¼•ç”¨äº† ujson é¡¹ç›®çš„ä»£ç , å› æ­¤éœ€è¦é™„ä¸Šå®ƒçš„ BSD åè®®:\nDeveloped by ESN, an Electronic Arts Inc. studio. Copyright (c) 2014, Electronic Arts Inc. All rights reserved. Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met: * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. * Neither the name of ESN, Electronic Arts Inc. nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL ELECTRONIC ARTS INC. BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. Portions of code from MODP_ASCII - Ascii transformations (upper/lower, etc) http://code.google.com/p/stringencoders/ Copyright (c) 2007 Nick Galbreath -- nickg [at] modp [dot] com. All rights reserved. Numeric decoder derived from from TCL library http://www.opensource.apple.com/source/tcl/tcl-14/tcl/license.terms * Copyright (c) 1988-1993 The Regents of the University of California. * Copyright (c) 1994 Sun Microsystems, Inc. ","wordCount":"1340","inLanguage":"zh-cmn-hans-cn","datePublished":"2016-05-30T19:16:51+08:00","dateModified":"2016-05-30T19:16:51+08:00","author":[{"@type":"Person","name":"WÃNG \"xen0n\" XuÄ›ruÃ¬"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.xen0n.name/posts/tinkering/ujson-symbol-chasing/"},"publisher":{"@type":"Organization","name":"write(2)","logo":{"@type":"ImageObject","url":"https://blog.xen0n.name/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.xen0n.name/ accesskey=h title="write(2) (Alt + H)">write(2)</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.xen0n.name/en/ title="English (US)" aria-label=:us:>ğŸ‡ºğŸ‡¸</a></li></ul></div></div><ul id=menu><li><a href=https://blog.xen0n.name/archives title=æ‰€æœ‰æ–‡ç« ><span>æ‰€æœ‰æ–‡ç« </span></a></li><li><a href=https://blog.xen0n.name/%E6%96%87%E7%AB%A0%E7%B1%BB%E5%88%AB title=æ–‡ç« ç±»åˆ«><span>æ–‡ç« ç±»åˆ«</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.xen0n.name/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://blog.xen0n.name/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">è·Ÿ ujson ç©ç¬¦å·æ‰è¿·è—</h1><div class=post-meta><span title='2016-05-30 19:16:51 +0800 +0800'>2016/05/30</span>&nbsp;Â·&nbsp;é¢„è®¡é˜…è¯»æ—¶é—´: 3 åˆ†é’Ÿ&nbsp;Â·&nbsp;WÃNG "xen0n" XuÄ›ruÃ¬</div></header><div class=post-content><h2 id=tldr>tl;dr<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>Python çš„ é«˜æ€§èƒ½ JSON åº“ <code>ujson</code> æˆªè‡³ç›®å‰åœ¨ Gentoo (GCC 5.3.0) ä¸
<a href=https://github.com/esnme/ultrajson/issues/180>FreeBSD 10</a> ä¸Šä½¿ç”¨æ—¶éƒ½å¯èƒ½ç¢°åˆ° <code>ImportError</code> é”™è¯¯.
è¯¥é”™è¯¯çš„ä¿®å¤è¡¥ä¸å·²ç»<a href=https://github.com/esnme/ultrajson/pull/222>æäº¤ä¸Šæ¸¸</a>, ä¼°è®¡è¿‡ä¸€é˜µå­å°±èƒ½ç”¨ä¸Šäº†!</p><h2 id=é—®é¢˜>é—®é¢˜<a hidden class=anchor aria-hidden=true href=#é—®é¢˜>#</a></h2><p>é«˜é«˜å…´å…´åœ°å¼€äº†ä¸€ä¸ªæ–°å‘, åˆå§‹åŒ–äº†è™šæ‹Ÿç¯å¢ƒ, å› ä¸ºé©¬ä¸Šè¦å¤„ç†ä¸€ä¸ªå·¨å¤§çš„ JSON
æ‰€ä»¥è£…ä¸Šäº† <code>ujson</code>. å¼€å§‹å¹²æ´»!</p><pre tabindex=0><code>In [1]: import ujson
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)
&lt;ipython-input-1-580339775a25&gt; in &lt;module&gt;()
----&gt; 1 import ujson

ImportError: /.../ujson.so: undefined symbol: Buffer_AppendShortHexUnchecked
</code></pre><p>(æ–‡ä»¶è·¯å¾„å¾ˆé•¿, ç¼–è¾‘æ‰äº†å¤§éƒ¨åˆ†)</p><h2 id=è§£å†³>è§£å†³<a hidden class=anchor aria-hidden=true href=#è§£å†³>#</a></h2><p>è¿™æ˜¯ä»€ä¹ˆæƒ…å†µ? æœç´¢äº†ä¸€åœˆ, æœç„¶æˆ‘<a href=https://archives.gentoo.org/gentoo-user/message/a17dc1393d347a89f63d8e0db4734e6e>ä¸æ˜¯</a><a href=https://github.com/esnme/ultrajson/issues/180>ä¸€ä¸ªäºº</a>,
ä¸è¿‡çœ‹èµ·æ¥åº”è¯¥æŒºç®€å•çš„æ ·å­å› ä¸º Gentoo é‚®ä»¶åˆ—è¡¨çš„é‚£ä¸ªäººæœºå™¨ä¸Šè™šæ‹Ÿç¯å¢ƒå¤–çš„å®‰è£…æ˜¯æ­£å¸¸çš„?!
å†åŠ ä¸Šè¿™ä¸ªé—®é¢˜ä¹‹å‰æˆ‘åœ¨å¾ˆå¤š Gentoo ç³»ç»Ÿä¸Šä¹Ÿä»æ¥æ²¡æœ‰é‡åˆ°, è¿™å°±è¯´æ˜é—®é¢˜åº”è¯¥å±€é™åœ¨
Python åŒ…é‡Œé¢, è€Œä¸”è·Ÿå…·ä½“ç³»ç»Ÿé…ç½®åº”è¯¥ä¹Ÿæœ‰å…³ç³».</p><p>å› ä¸º <code>ujson</code> æ˜¯ä¸€ä¸ªçº¯ C å†™æˆçš„ Python æ‰©å±•, æœ¬èº«ä¹Ÿæ”¯æŒ Python 3 (æˆ‘ä½¿ç”¨çš„æ˜¯
Python 3.5 åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ), æ‰€ä»¥é—®é¢˜åº”è¯¥è·Ÿ Python çš„ ABI æ— å…³. ç»è¿‡ç®€å•çš„ç½‘ç»œæœç´¢å’Œ
grep, å‡ºé—®é¢˜çš„å‡½æ•°æ˜¯ <code>ujson</code> çš„ä¸€ä¸ªå†…éƒ¨ helper å‡½æ•°, è¿™å°± 10000% ç¡®å®šæ˜¯ <code>ujson</code>
æœ¬èº«çš„ bug äº†. æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å£°æ˜:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* ä¸ºäº†æ¸…æ™°, æ¢è¡Œæ˜¯æˆ‘åŠ çš„ */</span>
</span></span><span style=display:flex><span>FASTCALL_ATTR INLINE_PREFIX
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span>
</span></span><span style=display:flex><span>FASTCALL_MSVC
</span></span><span style=display:flex><span><span style=color:#a6e22e>Buffer_AppendShortHexUnchecked</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>outputOffset, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span> value);
</span></span></code></pre></div><p>è¿˜æœ‰ FreeBSD issue ä¸­æåˆ°çš„ <code>strreverse</code> çš„:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>FASTCALL_ATTR INLINE_PREFIX
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span>
</span></span><span style=display:flex><span>FASTCALL_MSVC
</span></span><span style=display:flex><span><span style=color:#a6e22e>strreverse</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> begin, <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> end);
</span></span></code></pre></div><p>æ‘˜æŠ„ä¸‹è¿™é‡Œçš„å®å®šä¹‰, å¯ä»¥çœ‹åˆ°è¿™äº›å®šä¹‰æ¯”è¾ƒç®€é™‹ (å¹³å°è·Ÿç¼–è¯‘å™¨æ˜¯å¹³è¡Œçš„æ¦‚å¿µ,
æ¯”æ–¹è¯´å¹¶ä¸æ˜¯æ‰€æœ‰ Windows ç¨‹åºéƒ½æ˜¯ç”¨ MSVC ç¼–è¯‘çš„,
å®Œæ•´æ–‡ä»¶çš„ Windows éƒ¨åˆ†é‡Œè¿˜æœ‰ <code>__declspec(dllexport)</code> è¿™ç§ä¸œè¥¿,
è¿™ç§ä»£ç æ”¾åˆ° MinGW GCC ä¸‹å°±è¦ç¼–è¯‘é”™è¯¯äº†), ä¸è¿‡å¹¶ä¸å½±å“é˜…è¯»:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#ifdef _WIN32
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define FASTCALL_MSVC __fastcall
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define FASTCALL_ATTR
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INLINE_PREFIX __inline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define FASTCALL_MSVC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#if !defined __x86_64__
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define FASTCALL_ATTR __attribute__((fastcall))
</span></span></span><span style=display:flex><span><span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define FASTCALL_ATTR
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define INLINE_PREFIX inline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span></code></pre></div><p>å…¶ä»–å‡½æ•°çš„å£°æ˜éƒ½æ²¡æœ‰è¿™äº› fastcall å’Œå†…è”çš„æ ‡è®°, å› æ­¤é—®é¢˜å°±å‡ºåœ¨ fastcall æˆ–è€…å†…è”ä¸Š.
ä¸è¿‡ fastcall æ˜¯ <a href=https://en.wikipedia.org/wiki/X86_calling_conventions#Microsoft_fastcall>x86-32 çš„ä¸€ç§è°ƒç”¨çº¦å®š</a>, åœ¨ AMD64 ä¸Šå¹¶ä¸å­˜åœ¨,
é‚£ä¹ˆé—®é¢˜åªèƒ½æ˜¯å› ä¸ºå†…è”äº†.</p><p>å„ä½è¿˜è®°å¾— C å†…è”å‡½æ•°ä½¿ç”¨çš„å°ç»†èŠ‚å—? (æ­¤å¤„å¯ä»¥æš‚åœä¸‹æ¥ Google æˆ–è€…ç¿»ä¹¦å“¦)</p><p>æ²¡é”™, <code>inline</code> åªæ˜¯ç»™ç¼–è¯‘å™¨çš„<strong>å»ºè®®</strong>è€Œä¸æ˜¯<strong>å‘½ä»¤</strong>, åˆ°åº•æ˜¯å¦å†…è”ç¼–è¯‘å™¨å®Œå…¨å¯ä»¥è‡ªè¡Œå†³å®š.
ä¸€èˆ¬æƒ…å†µä¸‹ç¼–è¯‘å™¨æ¯”äººè¦èªæ˜, æ‰€ä»¥è¿™æ ·çš„è®¾å®šå¹¶ä¸ä¼šäº§ç”Ÿé—®é¢˜;
é—®é¢˜åœ¨äºæœ‰äº›æ—¶å€™äººç±»ç¡®å®æ˜ç™½è‡ªå·±åœ¨åšçš„äº‹æƒ…,
å°¤å…¶æ˜¯ç¼–è¯‘å™¨åå¯¹äººçš„æƒ³æ³•ä¹‹åè‡ªå·±åšçš„äº‹æƒ…å´ä¸ä¸€å®šæ­£ç¡® (å› ä¸ºç¼–è¯‘å™¨ä¹Ÿæ˜¯äººå†™çš„, ä¼šæœ‰ bug å•Š)&mldr;
å› ä¸ºå¾ˆä¹…ä¹‹å‰å¹¶æ²¡æœ‰è¿™æ ·çš„é—®é¢˜, æœ€è¿‘ä¸¤å¹´ (2015-08 ä¹‹å) æ‰å¼€å§‹å‡ºç°,
æ‰€ä»¥ç”¨ç³»ç»Ÿä¸Šçš„ä¸¤ä¸ª gcc ç‰ˆæœ¬æµ‹è¯•äº†ä¸€ä¸‹:</p><pre tabindex=0><code>$ nm ujson.gcc-4.9.3.so | grep &#39;strreverse\|Buffer_AppendShortHex&#39;
0000000000007557 T Buffer_AppendShortHexUnchecked
0000000000007557 t Buffer_AppendShortHexUnchecked.localalias.1
000000000000805d T strreverse
000000000000805d t strreverse.localalias.0
$ nm ujson.gcc-5.3.0.so | grep &#39;strreverse\|Buffer_AppendShortHex&#39;
                 U Buffer_AppendShortHexUnchecked
                 U strreverse
</code></pre><p>æœç„¶! é‚£æˆ‘ä»¬æŠŠä¸¤ä¸ªå‡½æ•°æ ‡è®°æˆå¼ºåˆ¶å†…è”å°±å¥½äº†:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/lib/ultrajson.h b/lib/ultrajson.h
</span></span><span style=display:flex><span>index 6b1fb85..894f367 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/lib/ultrajson.h
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/lib/ultrajson.h
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -115,7 +115,11 @@ typedef uint32_t JSUINT32;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> #define FASTCALL_ATTR
</span></span><span style=display:flex><span> #endif
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+#ifdef __GNUC__
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+#define INLINE_PREFIX __attribute__((always_inline)) inline
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+#else
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> #define INLINE_PREFIX inline
</span></span><span style=display:flex><span><span style=color:#a6e22e>+#endif
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span> typedef uint8_t JSUINT8;
</span></span><span style=display:flex><span> typedef uint16_t JSUTF16;
</span></span></code></pre></div><p>å› ä¸ºæ²¡æœ‰ç”¨è¿‡åˆ«çš„ç¼–è¯‘å™¨, æ‰€ä»¥æˆ‘åªæ·»åŠ äº† GCC çš„åˆ¤æ–­å’Œç›¸åº”ä»£ç ,
ä¸è¿‡è‡ªç„¶ä¼šæœ‰äººæ¥æ·»åŠ å…¶ä»–çš„æ‰€ä»¥å°±æ— æ‰€è°“äº†&mldr;
æµ‹è¯•ä¸€ä¸‹:</p><pre tabindex=0><code>$ nm ujson.gcc-5.3.0-always_inline.so | grep &#39;strreverse\|Buffer_AppendShortHex&#39;
$
</code></pre><p>ä¸¤ä¸ªå‡½æ•°åå·²ç»ä¸å­˜åœ¨äº†, è¿™å¾ˆæ­£å¸¸, å› ä¸ºå®ƒä»¬éƒ½è¢«å†…è”äº†å•Š, <code>import</code> çœ‹çœ‹:</p><pre tabindex=0><code>In [1]: import ujson

In [2]:
</code></pre><p>å¥½!</p><h2 id=é™„-ujson-ç‰ˆæƒå£°æ˜>é™„: ujson ç‰ˆæƒå£°æ˜<a hidden class=anchor aria-hidden=true href=#é™„-ujson-ç‰ˆæƒå£°æ˜>#</a></h2><p>æœ¬æ–‡å¼•ç”¨äº† <code>ujson</code> é¡¹ç›®çš„ä»£ç , å› æ­¤éœ€è¦é™„ä¸Šå®ƒçš„ BSD åè®®:</p><pre tabindex=0><code>Developed by ESN, an Electronic Arts Inc. studio.
Copyright (c) 2014, Electronic Arts Inc.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
* Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.
* Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.
* Neither the name of ESN, Electronic Arts Inc. nor the
names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34; AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL ELECTRONIC ARTS INC. BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


Portions of code from MODP_ASCII - Ascii transformations (upper/lower, etc)
http://code.google.com/p/stringencoders/
Copyright (c) 2007  Nick Galbreath -- nickg [at] modp [dot] com. All rights reserved.

Numeric decoder derived from from TCL library
http://www.opensource.apple.com/source/tcl/tcl-14/tcl/license.terms
 * Copyright (c) 1988-1993 The Regents of the University of California.
 * Copyright (c) 1994 Sun Microsystems, Inc.
</code></pre></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://blog.xen0n.name/posts/tinkering/simple-polyglot-python-trick/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>Python å¥‡æŠ€æ·«å·§: ä¸€ç§ç®€å•çš„ Python / Shell åŒè¯­ç¨‹åº</span>
</a><a class=next href=https://blog.xen0n.name/posts/old/meizu-mx4-cm/cm-12.1-userdebug-11/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>CyanogenMod for é­…æ— MX4: CM12.1 20160411 æµ‹è¯•åŒ…å‘å¸ƒ</span></a></nav></footer><script src=https://utteranc.es/client.js repo=xen0n/xen0n.github.io issue-term=pathname label=comment theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2013-2023 WANG Xuerui; ä»¥ <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>cc-by-nc-sa 4.0</a> æˆæƒ</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><span><a href=https://beian.miit.gov.cn target=_blank>è‹ICPå¤‡17027553å·-1</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>