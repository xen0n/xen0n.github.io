<!doctype html><html lang=zh-cmn-hans-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>跟 ujson 玩符号捉迷藏 | write(2)</title>
<meta name=keywords content><meta name=description content="tl;dr Python 的 高性能 JSON 库 ujson 截至目前在 Gentoo (GCC 5.3.0) 与 FreeBSD 10 上使用时都可能碰到 ImportError 错误. 该错误的修复补丁已经提交上游, 估计过一阵子就能用上了! 问题 高高兴兴地开了一"><meta name=author content="WÁNG &#34;xen0n&#34; Xuěruì"><link rel=canonical href=https://blog.xen0n.name/posts/tinkering/ujson-symbol-chasing/><link crossorigin=anonymous href=/assets/css/stylesheet.41f810764fcdd619307656c791833b60b7b03fee6398926d0dd5336d9ffbf77d.css integrity="sha256-QfgQdk/N1hkwdlbHkYM7YLewP+5jmJJtDdUzbZ/7930=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.xen0n.name/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.xen0n.name/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.xen0n.name/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.xen0n.name/apple-touch-icon.png><link rel=mask-icon href=https://blog.xen0n.name/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cmn-hans-cn href=https://blog.xen0n.name/posts/tinkering/ujson-symbol-chasing/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="跟 ujson 玩符号捉迷藏"><meta property="og:description" content="tl;dr Python 的 高性能 JSON 库 ujson 截至目前在 Gentoo (GCC 5.3.0) 与 FreeBSD 10 上使用时都可能碰到 ImportError 错误. 该错误的修复补丁已经提交上游, 估计过一阵子就能用上了! 问题 高高兴兴地开了一"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.xen0n.name/posts/tinkering/ujson-symbol-chasing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-05-30T19:16:51+08:00"><meta property="article:modified_time" content="2016-05-30T19:16:51+08:00"><meta property="og:site_name" content="write(2)"><meta name=twitter:card content="summary"><meta name=twitter:title content="跟 ujson 玩符号捉迷藏"><meta name=twitter:description content="tl;dr Python 的 高性能 JSON 库 ujson 截至目前在 Gentoo (GCC 5.3.0) 与 FreeBSD 10 上使用时都可能碰到 ImportError 错误. 该错误的修复补丁已经提交上游, 估计过一阵子就能用上了! 问题 高高兴兴地开了一"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.xen0n.name/posts/"},{"@type":"ListItem","position":2,"name":"跟 ujson 玩符号捉迷藏","item":"https://blog.xen0n.name/posts/tinkering/ujson-symbol-chasing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"跟 ujson 玩符号捉迷藏","name":"跟 ujson 玩符号捉迷藏","description":"tl;dr Python 的 高性能 JSON 库 ujson 截至目前在 Gentoo (GCC 5.3.0) 与 FreeBSD 10 上使用时都可能碰到 ImportError 错误. 该错误的修复补丁已经提交上游, 估计过一阵子就能用上了! 问题 高高兴兴地开了一","keywords":[],"articleBody":"tl;dr Python 的 高性能 JSON 库 ujson 截至目前在 Gentoo (GCC 5.3.0) 与 FreeBSD 10 上使用时都可能碰到 ImportError 错误. 该错误的修复补丁已经提交上游, 估计过一阵子就能用上了!\n问题 高高兴兴地开了一个新坑, 初始化了虚拟环境, 因为马上要处理一个巨大的 JSON 所以装上了 ujson. 开始干活!\nIn [1]: import ujson --------------------------------------------------------------------------- ImportError Traceback (most recent call last) in () ----\u003e 1 import ujson ImportError: /.../ujson.so: undefined symbol: Buffer_AppendShortHexUnchecked (文件路径很长, 编辑掉了大部分)\n解决 这是什么情况? 搜索了一圈, 果然我不是一个人, 不过看起来应该挺简单的样子因为 Gentoo 邮件列表的那个人机器上虚拟环境外的安装是正常的?! 再加上这个问题之前我在很多 Gentoo 系统上也从来没有遇到, 这就说明问题应该局限在 Python 包里面, 而且跟具体系统配置应该也有关系.\n因为 ujson 是一个纯 C 写成的 Python 扩展, 本身也支持 Python 3 (我使用的是 Python 3.5 创建虚拟环境), 所以问题应该跟 Python 的 ABI 无关. 经过简单的网络搜索和 grep, 出问题的函数是 ujson 的一个内部 helper 函数, 这就 10000% 确定是 ujson 本身的 bug 了. 我们来看一下这个函数的声明:\n/* 为了清晰, 换行是我加的 */ FASTCALL_ATTR INLINE_PREFIX void FASTCALL_MSVC Buffer_AppendShortHexUnchecked(char *outputOffset, unsigned short value); 还有 FreeBSD issue 中提到的 strreverse 的:\nFASTCALL_ATTR INLINE_PREFIX void FASTCALL_MSVC strreverse(char* begin, char* end); 摘抄下这里的宏定义, 可以看到这些定义比较简陋 (平台跟编译器是平行的概念, 比方说并不是所有 Windows 程序都是用 MSVC 编译的, 完整文件的 Windows 部分里还有 __declspec(dllexport) 这种东西, 这种代码放到 MinGW GCC 下就要编译错误了), 不过并不影响阅读:\n#ifdef _WIN32 #define FASTCALL_MSVC __fastcall #define FASTCALL_ATTR #define INLINE_PREFIX __inline #else #define FASTCALL_MSVC #if !defined __x86_64__ #define FASTCALL_ATTR __attribute__((fastcall)) #else #define FASTCALL_ATTR #endif #define INLINE_PREFIX inline #endif 其他函数的声明都没有这些 fastcall 和内联的标记, 因此问题就出在 fastcall 或者内联上. 不过 fastcall 是 x86-32 的一种调用约定, 在 AMD64 上并不存在, 那么问题只能是因为内联了.\n各位还记得 C 内联函数使用的小细节吗? (此处可以暂停下来 Google 或者翻书哦)\n没错, inline 只是给编译器的建议而不是命令, 到底是否内联编译器完全可以自行决定. 一般情况下编译器比人要聪明, 所以这样的设定并不会产生问题; 问题在于有些时候人类确实明白自己在做的事情, 尤其是编译器反对人的想法之后自己做的事情却不一定正确 (因为编译器也是人写的, 会有 bug 啊)… 因为很久之前并没有这样的问题, 最近两年 (2015-08 之后) 才开始出现, 所以用系统上的两个 gcc 版本测试了一下:\n$ nm ujson.gcc-4.9.3.so | grep 'strreverse\\|Buffer_AppendShortHex' 0000000000007557 T Buffer_AppendShortHexUnchecked 0000000000007557 t Buffer_AppendShortHexUnchecked.localalias.1 000000000000805d T strreverse 000000000000805d t strreverse.localalias.0 $ nm ujson.gcc-5.3.0.so | grep 'strreverse\\|Buffer_AppendShortHex' U Buffer_AppendShortHexUnchecked U strreverse 果然! 那我们把两个函数标记成强制内联就好了:\ndiff --git a/lib/ultrajson.h b/lib/ultrajson.h index 6b1fb85..894f367 100644 --- a/lib/ultrajson.h +++ b/lib/ultrajson.h @@ -115,7 +115,11 @@ typedef uint32_t JSUINT32; #define FASTCALL_ATTR #endif +#ifdef __GNUC__ +#define INLINE_PREFIX __attribute__((always_inline)) inline +#else #define INLINE_PREFIX inline +#endif typedef uint8_t JSUINT8; typedef uint16_t JSUTF16; 因为没有用过别的编译器, 所以我只添加了 GCC 的判断和相应代码, 不过自然会有人来添加其他的所以就无所谓了… 测试一下:\n$ nm ujson.gcc-5.3.0-always_inline.so | grep 'strreverse\\|Buffer_AppendShortHex' $ 两个函数名已经不存在了, 这很正常, 因为它们都被内联了啊, import 看看:\nIn [1]: import ujson In [2]: 好!\n附: ujson 版权声明 本文引用了 ujson 项目的代码, 因此需要附上它的 BSD 协议:\nDeveloped by ESN, an Electronic Arts Inc. studio. Copyright (c) 2014, Electronic Arts Inc. All rights reserved. Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met: * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. * Neither the name of ESN, Electronic Arts Inc. nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL ELECTRONIC ARTS INC. BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. Portions of code from MODP_ASCII - Ascii transformations (upper/lower, etc) http://code.google.com/p/stringencoders/ Copyright (c) 2007 Nick Galbreath -- nickg [at] modp [dot] com. All rights reserved. Numeric decoder derived from from TCL library http://www.opensource.apple.com/source/tcl/tcl-14/tcl/license.terms * Copyright (c) 1988-1993 The Regents of the University of California. * Copyright (c) 1994 Sun Microsystems, Inc. ","wordCount":"1340","inLanguage":"zh-cmn-hans-cn","datePublished":"2016-05-30T19:16:51+08:00","dateModified":"2016-05-30T19:16:51+08:00","author":[{"@type":"Person","name":"WÁNG \"xen0n\" Xuěruì"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.xen0n.name/posts/tinkering/ujson-symbol-chasing/"},"publisher":{"@type":"Organization","name":"write(2)","logo":{"@type":"ImageObject","url":"https://blog.xen0n.name/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.xen0n.name/ accesskey=h title="write(2) (Alt + H)">write(2)</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.xen0n.name/en/ title="English (US)" aria-label=:us:>🇺🇸</a></li></ul></div></div><ul id=menu><li><a href=https://blog.xen0n.name/archives title=所有文章><span>所有文章</span></a></li><li><a href=https://blog.xen0n.name/%E6%96%87%E7%AB%A0%E7%B1%BB%E5%88%AB title=文章类别><span>文章类别</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.xen0n.name/>主页</a>&nbsp;»&nbsp;<a href=https://blog.xen0n.name/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">跟 ujson 玩符号捉迷藏</h1><div class=post-meta><span title='2016-05-30 19:16:51 +0800 +0800'>2016/05/30</span>&nbsp;·&nbsp;预计阅读时间: 3 分钟&nbsp;·&nbsp;WÁNG "xen0n" Xuěruì</div></header><div class=post-content><h2 id=tldr>tl;dr<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>Python 的 高性能 JSON 库 <code>ujson</code> 截至目前在 Gentoo (GCC 5.3.0) 与
<a href=https://github.com/esnme/ultrajson/issues/180>FreeBSD 10</a> 上使用时都可能碰到 <code>ImportError</code> 错误.
该错误的修复补丁已经<a href=https://github.com/esnme/ultrajson/pull/222>提交上游</a>, 估计过一阵子就能用上了!</p><h2 id=问题>问题<a hidden class=anchor aria-hidden=true href=#问题>#</a></h2><p>高高兴兴地开了一个新坑, 初始化了虚拟环境, 因为马上要处理一个巨大的 JSON
所以装上了 <code>ujson</code>. 开始干活!</p><pre tabindex=0><code>In [1]: import ujson
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)
&lt;ipython-input-1-580339775a25&gt; in &lt;module&gt;()
----&gt; 1 import ujson

ImportError: /.../ujson.so: undefined symbol: Buffer_AppendShortHexUnchecked
</code></pre><p>(文件路径很长, 编辑掉了大部分)</p><h2 id=解决>解决<a hidden class=anchor aria-hidden=true href=#解决>#</a></h2><p>这是什么情况? 搜索了一圈, 果然我<a href=https://archives.gentoo.org/gentoo-user/message/a17dc1393d347a89f63d8e0db4734e6e>不是</a><a href=https://github.com/esnme/ultrajson/issues/180>一个人</a>,
不过看起来应该挺简单的样子因为 Gentoo 邮件列表的那个人机器上虚拟环境外的安装是正常的?!
再加上这个问题之前我在很多 Gentoo 系统上也从来没有遇到, 这就说明问题应该局限在
Python 包里面, 而且跟具体系统配置应该也有关系.</p><p>因为 <code>ujson</code> 是一个纯 C 写成的 Python 扩展, 本身也支持 Python 3 (我使用的是
Python 3.5 创建虚拟环境), 所以问题应该跟 Python 的 ABI 无关. 经过简单的网络搜索和
grep, 出问题的函数是 <code>ujson</code> 的一个内部 helper 函数, 这就 10000% 确定是 <code>ujson</code>
本身的 bug 了. 我们来看一下这个函数的声明:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* 为了清晰, 换行是我加的 */</span>
</span></span><span style=display:flex><span>FASTCALL_ATTR INLINE_PREFIX
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span>
</span></span><span style=display:flex><span>FASTCALL_MSVC
</span></span><span style=display:flex><span><span style=color:#a6e22e>Buffer_AppendShortHexUnchecked</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>outputOffset, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span> value);
</span></span></code></pre></div><p>还有 FreeBSD issue 中提到的 <code>strreverse</code> 的:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>FASTCALL_ATTR INLINE_PREFIX
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span>
</span></span><span style=display:flex><span>FASTCALL_MSVC
</span></span><span style=display:flex><span><span style=color:#a6e22e>strreverse</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> begin, <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> end);
</span></span></code></pre></div><p>摘抄下这里的宏定义, 可以看到这些定义比较简陋 (平台跟编译器是平行的概念,
比方说并不是所有 Windows 程序都是用 MSVC 编译的,
完整文件的 Windows 部分里还有 <code>__declspec(dllexport)</code> 这种东西,
这种代码放到 MinGW GCC 下就要编译错误了), 不过并不影响阅读:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#ifdef _WIN32
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define FASTCALL_MSVC __fastcall
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define FASTCALL_ATTR
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INLINE_PREFIX __inline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define FASTCALL_MSVC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#if !defined __x86_64__
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define FASTCALL_ATTR __attribute__((fastcall))
</span></span></span><span style=display:flex><span><span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define FASTCALL_ATTR
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define INLINE_PREFIX inline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span></code></pre></div><p>其他函数的声明都没有这些 fastcall 和内联的标记, 因此问题就出在 fastcall 或者内联上.
不过 fastcall 是 <a href=https://en.wikipedia.org/wiki/X86_calling_conventions#Microsoft_fastcall>x86-32 的一种调用约定</a>, 在 AMD64 上并不存在,
那么问题只能是因为内联了.</p><p>各位还记得 C 内联函数使用的小细节吗? (此处可以暂停下来 Google 或者翻书哦)</p><p>没错, <code>inline</code> 只是给编译器的<strong>建议</strong>而不是<strong>命令</strong>, 到底是否内联编译器完全可以自行决定.
一般情况下编译器比人要聪明, 所以这样的设定并不会产生问题;
问题在于有些时候人类确实明白自己在做的事情,
尤其是编译器反对人的想法之后自己做的事情却不一定正确 (因为编译器也是人写的, 会有 bug 啊)&mldr;
因为很久之前并没有这样的问题, 最近两年 (2015-08 之后) 才开始出现,
所以用系统上的两个 gcc 版本测试了一下:</p><pre tabindex=0><code>$ nm ujson.gcc-4.9.3.so | grep &#39;strreverse\|Buffer_AppendShortHex&#39;
0000000000007557 T Buffer_AppendShortHexUnchecked
0000000000007557 t Buffer_AppendShortHexUnchecked.localalias.1
000000000000805d T strreverse
000000000000805d t strreverse.localalias.0
$ nm ujson.gcc-5.3.0.so | grep &#39;strreverse\|Buffer_AppendShortHex&#39;
                 U Buffer_AppendShortHexUnchecked
                 U strreverse
</code></pre><p>果然! 那我们把两个函数标记成强制内联就好了:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/lib/ultrajson.h b/lib/ultrajson.h
</span></span><span style=display:flex><span>index 6b1fb85..894f367 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/lib/ultrajson.h
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/lib/ultrajson.h
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -115,7 +115,11 @@ typedef uint32_t JSUINT32;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> #define FASTCALL_ATTR
</span></span><span style=display:flex><span> #endif
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+#ifdef __GNUC__
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+#define INLINE_PREFIX __attribute__((always_inline)) inline
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+#else
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> #define INLINE_PREFIX inline
</span></span><span style=display:flex><span><span style=color:#a6e22e>+#endif
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span> typedef uint8_t JSUINT8;
</span></span><span style=display:flex><span> typedef uint16_t JSUTF16;
</span></span></code></pre></div><p>因为没有用过别的编译器, 所以我只添加了 GCC 的判断和相应代码,
不过自然会有人来添加其他的所以就无所谓了&mldr;
测试一下:</p><pre tabindex=0><code>$ nm ujson.gcc-5.3.0-always_inline.so | grep &#39;strreverse\|Buffer_AppendShortHex&#39;
$
</code></pre><p>两个函数名已经不存在了, 这很正常, 因为它们都被内联了啊, <code>import</code> 看看:</p><pre tabindex=0><code>In [1]: import ujson

In [2]:
</code></pre><p>好!</p><h2 id=附-ujson-版权声明>附: ujson 版权声明<a hidden class=anchor aria-hidden=true href=#附-ujson-版权声明>#</a></h2><p>本文引用了 <code>ujson</code> 项目的代码, 因此需要附上它的 BSD 协议:</p><pre tabindex=0><code>Developed by ESN, an Electronic Arts Inc. studio.
Copyright (c) 2014, Electronic Arts Inc.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
* Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.
* Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.
* Neither the name of ESN, Electronic Arts Inc. nor the
names of its contributors may be used to endorse or promote products
derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34; AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL ELECTRONIC ARTS INC. BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


Portions of code from MODP_ASCII - Ascii transformations (upper/lower, etc)
http://code.google.com/p/stringencoders/
Copyright (c) 2007  Nick Galbreath -- nickg [at] modp [dot] com. All rights reserved.

Numeric decoder derived from from TCL library
http://www.opensource.apple.com/source/tcl/tcl-14/tcl/license.terms
 * Copyright (c) 1988-1993 The Regents of the University of California.
 * Copyright (c) 1994 Sun Microsystems, Inc.
</code></pre></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://blog.xen0n.name/posts/tinkering/simple-polyglot-python-trick/><span class=title>« 上一页</span><br><span>Python 奇技淫巧: 一种简单的 Python / Shell 双语程序</span>
</a><a class=next href=https://blog.xen0n.name/posts/old/meizu-mx4-cm/cm-12.1-userdebug-11/><span class=title>下一页 »</span><br><span>CyanogenMod for 魅族 MX4: CM12.1 20160411 测试包发布</span></a></nav></footer><script src=https://utteranc.es/client.js repo=xen0n/xen0n.github.io issue-term=pathname label=comment theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2013-2023 WANG Xuerui; 以 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>cc-by-nc-sa 4.0</a> 授权</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><span><a href=https://beian.miit.gov.cn target=_blank>苏ICP备17027553号-1</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>