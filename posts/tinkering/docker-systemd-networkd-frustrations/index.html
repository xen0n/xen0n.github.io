<!doctype html><html lang=zh-cmn-hans-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Docker ä¸ systemd-networkd ä¹‹é—´ä¸å¾—ä¸è¯´çš„æ•…äº‹ | write(2)</title><meta name=keywords content><meta name=description content="tl;dr å¦‚æœä½ ä½¿ç”¨ systemd-networkd ç®¡ç†ä½ çš„ç½‘ç»œç•Œé¢, åˆæŠŠè¿™å°æœºå™¨ä½œä¸º Docker å®¹å™¨å®¿ä¸»çš„è¯, é‚£ä½ å¾ˆå¯èƒ½ä¼šå‘ç°ä½ çš„å®¹å™¨è¿‡ä¸€æ®µæ—¶é—´å°±ä¼šä¸èƒ½è®¿é—®å¤–ç½‘. ä½ éœ€è¦åœ¨ /etc/systemd/network/your.network é…ç½®é‡Œæ˜ç¡®å‘Šè¯‰"><meta name=author content="WÃNG &#34;xen0n&#34; XuÄ›ruÃ¬"><link rel=canonical href=https://blog.xen0n.name/posts/tinkering/docker-systemd-networkd-frustrations/><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.e85ad0406048e8176e1c7661b25d5c69297ddfe41dc4124cf75ecb99a4f7b3d1.js integrity="sha256-6FrQQGBI6BduHHZhsl1caSl93+QdxBJM917LmaT3s9E=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.xen0n.name/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.xen0n.name/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.xen0n.name/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.xen0n.name/apple-touch-icon.png><link rel=mask-icon href=https://blog.xen0n.name/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cmn-hans-cn href=https://blog.xen0n.name/posts/tinkering/docker-systemd-networkd-frustrations/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Docker ä¸ systemd-networkd ä¹‹é—´ä¸å¾—ä¸è¯´çš„æ•…äº‹"><meta property="og:description" content="tl;dr å¦‚æœä½ ä½¿ç”¨ systemd-networkd ç®¡ç†ä½ çš„ç½‘ç»œç•Œé¢, åˆæŠŠè¿™å°æœºå™¨ä½œä¸º Docker å®¹å™¨å®¿ä¸»çš„è¯, é‚£ä½ å¾ˆå¯èƒ½ä¼šå‘ç°ä½ çš„å®¹å™¨è¿‡ä¸€æ®µæ—¶é—´å°±ä¼šä¸èƒ½è®¿é—®å¤–ç½‘. ä½ éœ€è¦åœ¨ /etc/systemd/network/your.network é…ç½®é‡Œæ˜ç¡®å‘Šè¯‰"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.xen0n.name/posts/tinkering/docker-systemd-networkd-frustrations/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-11-05T15:45:00+08:00"><meta property="article:modified_time" content="2015-11-05T15:45:00+08:00"><meta property="og:site_name" content="write(2)"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker ä¸ systemd-networkd ä¹‹é—´ä¸å¾—ä¸è¯´çš„æ•…äº‹"><meta name=twitter:description content="tl;dr å¦‚æœä½ ä½¿ç”¨ systemd-networkd ç®¡ç†ä½ çš„ç½‘ç»œç•Œé¢, åˆæŠŠè¿™å°æœºå™¨ä½œä¸º Docker å®¹å™¨å®¿ä¸»çš„è¯, é‚£ä½ å¾ˆå¯èƒ½ä¼šå‘ç°ä½ çš„å®¹å™¨è¿‡ä¸€æ®µæ—¶é—´å°±ä¼šä¸èƒ½è®¿é—®å¤–ç½‘. ä½ éœ€è¦åœ¨ /etc/systemd/network/your.network é…ç½®é‡Œæ˜ç¡®å‘Šè¯‰"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.xen0n.name/posts/"},{"@type":"ListItem","position":2,"name":"Docker ä¸ systemd-networkd ä¹‹é—´ä¸å¾—ä¸è¯´çš„æ•…äº‹","item":"https://blog.xen0n.name/posts/tinkering/docker-systemd-networkd-frustrations/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Docker ä¸ systemd-networkd ä¹‹é—´ä¸å¾—ä¸è¯´çš„æ•…äº‹","name":"Docker ä¸ systemd-networkd ä¹‹é—´ä¸å¾—ä¸è¯´çš„æ•…äº‹","description":"tl;dr å¦‚æœä½ ä½¿ç”¨ systemd-networkd ç®¡ç†ä½ çš„ç½‘ç»œç•Œé¢, åˆæŠŠè¿™å°æœºå™¨ä½œä¸º Docker å®¹å™¨å®¿ä¸»çš„è¯, é‚£ä½ å¾ˆå¯èƒ½ä¼šå‘ç°ä½ çš„å®¹å™¨è¿‡ä¸€æ®µæ—¶é—´å°±ä¼šä¸èƒ½è®¿é—®å¤–ç½‘. ä½ éœ€è¦åœ¨ /etc/systemd/network/your.network é…ç½®é‡Œæ˜ç¡®å‘Šè¯‰","keywords":[],"articleBody":"tl;dr å¦‚æœä½ ä½¿ç”¨ systemd-networkd ç®¡ç†ä½ çš„ç½‘ç»œç•Œé¢, åˆæŠŠè¿™å°æœºå™¨ä½œä¸º Docker å®¹å™¨å®¿ä¸»çš„è¯, é‚£ä½ å¾ˆå¯èƒ½ä¼šå‘ç°ä½ çš„å®¹å™¨è¿‡ä¸€æ®µæ—¶é—´å°±ä¼šä¸èƒ½è®¿é—®å¤–ç½‘. ä½ éœ€è¦åœ¨ /etc/systemd/network/your.network é…ç½®é‡Œæ˜ç¡®å‘Šè¯‰ systemd-networkd å¼€å¯æŠ¥æ–‡è½¬å‘:\n# ... [Network] # ... IPForward=yes å¹¶ä¸æ„‰å¿«çš„ç»å† æˆ‘æœ‰ä¸€å°æ‰“ç®—åš Docker å®¹å™¨å®¿ä¸»çš„æœåŠ¡å™¨, ç„¶è€Œéƒ¨ç½²å®Œæˆä¸ä¹…å°±å‘ç°äº†ä¸€ä¸ªä¸¥é‡é—®é¢˜ â€“ å®¹å™¨ä¸èƒ½è®¿é—®å¤–ç½‘! å¥½å§å®é™…ä¸Šè¿˜æ˜¯å¯ä»¥çš„â€¦ åˆšå¼€æœºå°±å¯åŠ¨çš„ Docker å®¹å™¨å¯ä»¥è”ç½‘, è¿‡ä¸€ä¼šå¯åŠ¨çš„å®¹å™¨ä¹Ÿèƒ½, ä½†å†è¿‡ä¸€ä¼šå°±ä¸è¡Œäº†; æ•…éšœæ—¶é—´ä¹Ÿä¸ä¸€å®š, æœ‰æ—¶å€™å¼€æœºå‡ åˆ†é’Ÿå°±æ–­ç½‘äº†, æœ‰æ—¶å€™èƒ½æ’‘åŠä¸ªå°æ—¶, å®Œå…¨æ²¡æœ‰è§„å¾‹. å°±è¿™æ ·é—²ç½®äº†åŠå¹´ä¹‹ä¹…!\næœ€è¿‘å› ä¸ºåšé¡¹ç›®, åˆæœ‰äº†ç”¨å®¹å™¨çš„éœ€æ±‚, å°±æƒ³ç€å›æ¥è°ƒè¯•ä¸€ä¸‹å§; æ›´æ–°äº†æ‰€æœ‰è½¯ä»¶åˆ°æœ€æ–°ç‰ˆæœ¬, ä¹Ÿå‡çº§äº†å†…æ ¸åˆ°æœ€æ–°çš„ Gentoo Hardened 4.2.5 ç‰ˆæœ¬, ç„¶è€Œæƒ…å†µå¹¶æ²¡æœ‰å˜åŒ–. å› ä¸ºåˆšåˆšé—²äº†ä¸‹æ¥, å°±å½»å½»åº•åº•åœ°è§£å†³è¿™ä¸ªé—®é¢˜å¥½äº†, äºæ˜¯æˆ‘æ‰“å¼€äº†å†…æ ¸æºç  ;-)\næ­£å¸¸çš„æµé‡ ä¹‹å‰å°±åœ¨æœºå™¨ä¸ŠæŠ“è¿‡ä¸€æ¬¡åŒ…, æƒ³çœ‹çœ‹ä¸ºä»€ä¹ˆå®¹å™¨æ²¡æœ‰æ”¶åˆ°å“åº”. å› ä¸ºæ–­ç½‘çš„åŸå› æ˜¯å¤šç§å¤šæ ·çš„, å¯èƒ½æ˜¯æŠ¥æ–‡æ²¡æœ‰å‡º docker0 ç•Œé¢, æŠ¥æ–‡æ²¡æœ‰ä¸Šåˆ°ç‰©ç†ç•Œé¢, æŠ¥æ–‡æ²¡æœ‰æ­£ç¡®è¢« NAT å› Docker å†…ç½‘åœ°å€, è¿˜å¯èƒ½æ˜¯å…¶ä»–æ›´ç¥å¥‡çš„åŸå› . æˆ‘åœ¨å®¹å™¨é‡Œ ping å®¿ä¸»çš„ç½‘å…³å’Œ DNS æœåŠ¡å™¨, åœ¨å®¿ä¸»ä¸ŠæŠ“åŒ…, ç„¶è€Œçœ‹åˆ°ç»“æœä¹‹åæˆ‘å‡ ä¹ç–¯æ‰äº†â€¦\nç‰©ç†ç•Œé¢ä¸Šæœ‰å®Œæ•´çš„ ICMP Ping è¯·æ±‚å’Œå“åº”åŒ…, ç„¶è€Œ docker0 ä¸Šçš„å“åº”è¢«åƒæ‰äº†!\næˆ‘åˆé€šè¿‡æ‹¼æ‰‹é€Ÿ, è®¾æ³•æŠ“åˆ°äº†æ–­ç½‘ä¸€ç¬é—´å‰åçš„ç½‘ç»œæµé‡, ä»ç„¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜; åœ¨æŸä¸ªæ—¶é—´ç‚¹è¿‡å, å“åº”åŒ…å°±æ˜¯æ¶ˆå¤±äº†, å®Œå…¨ä¸è®²é“ç†. æˆ‘è§‰å¾—é—®é¢˜å¯èƒ½å‡ºåœ¨ Linux å†…æ ¸æœ¬èº«äº†.\nä»ç„¶æ­£å¸¸çš„ iptables Docker é»˜è®¤çš„å®¹å™¨è”ç½‘æ–¹å¼æ˜¯æ¡¥æ¥ç½‘ç»œ, å°±æ˜¯:\nDocker å¯åŠ¨æ—¶åˆå§‹åŒ–ä¸€ä¸ªç½‘æ¡¥ docker0, è®¾ç½® iptables è®©é¢„å…ˆé…ç½®çš„ Docker ç½‘æ®µèƒ½ NAT åˆ°å¤–ç½‘ å®¹å™¨å¯åŠ¨æ—¶, é¦–å…ˆåˆ›å»ºä¸€å¯¹ vethXXXXXX è™šæ‹Ÿç•Œé¢, ä¸€ç«¯å¡è¿›å®¹å™¨çš„ netns é‡Œ, ä¸€ç«¯ç•™åœ¨å®¿ä¸» ç„¶åæŠŠå®¿ä¸»ä¸€ä¾§çš„ veth ç•Œé¢æ¥å…¥ docker0 å¦‚æœæœ‰è®¾ç½®ç«¯å£æ˜ å°„çš„è¯, å°±ä¸ºå¯¹åº”çš„å®¹å™¨ IP å’Œç«¯å£è®¾ç½® MASQUERADE å’Œ DNAT å…·ä½“æƒ…å†µå„ä½å¯ä»¥è‡ªè¡Œåœ¨è·‘ Docker çš„æœºå™¨ä¸Šçœ‹ä¸€çœ‹ iptables -nvL å’Œ iptables -t nat -nvL çš„è¾“å‡º, ä¸è¿‡åº”è¯¥åŒºåˆ«ä¸å¤§.\nå› ä¸ºä¸¢åŒ…çš„è¯é¦–å…ˆå°±æ˜¯è€ƒè™‘ iptables æ˜¯ä¸æ˜¯æŠŠåŒ…ç»™ DROP äº†, æˆ‘æ˜¾ç„¶ä¹Ÿæ˜¯æ£€æŸ¥äº†ä¸€ä¸‹, ç„¶è€Œ DROP ä¸€æ¬¡éƒ½æ²¡æœ‰å‡ºç°â€¦ (å› ä¸ºæœåŠ¡å™¨æ‰˜ç®¡åœ¨å­¦æ ¡ç½‘ç»œä¸­å¿ƒ, æˆ‘æš‚æ—¶æ²¡æœ‰å•ç‹¬è®¾ç½®é˜²ç«å¢™)\nè¿™ä¸ç§‘å­¦, å› æ­¤æˆ‘åšäº†è¿™ä¸ªæ“ä½œç»™æ‰€æœ‰ ICMP åŒ…å¯ç”¨äº†è·Ÿè¸ª:\n# é¦–å…ˆéœ€è¦åŠ è½½ xt_LOG æ¨¡å—, è¿™æ · TRACE æ‰æœ‰æ•ˆ, å®é™…ä¸Š modprobe xt_LOG å°±è¡Œäº† # ç„¶è€Œæˆ‘ç›´æ¥æ·»åŠ äº†ä¸€æ¡è§„åˆ™, æ•ˆæœä¸€æ · iptables -t nat -I PREROUTING 1 -p icmp -j LOG iptables -t raw -A PREROUTING -p icmp -j TRACE iptables -t raw -A OUTPUT -p icmp -j TRACE ç»§ç»­æ‹¼æ‰‹é€Ÿæ‰“å‡ºäº†æ–­ç½‘å‰åçš„ trace å¯¹æ¯” (æŠŠ IP å’Œç¡¬ä»¶åœ°å€æ‰“ç äº†, å¹¶ä¸”æ”¹äº† Docker çš„ç½‘æ®µ):\n[ 118.520085] TRACE: raw:PREROUTING:policy:2 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64 [ 118.520091] TRACE: mangle:PREROUTING:policy:1 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64 [ 118.520097] TRACE: mangle:FORWARD:policy:1 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64 [ 118.520101] TRACE: filter:FORWARD:rule:1 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64 [ 118.520105] TRACE: filter:DOCKER:return:2 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64 [ 118.520109] TRACE: filter:FORWARD:rule:2 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64 [ 118.520112] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=docker0 SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64 å’Œ\n[ 275.429990] TRACE: raw:PREROUTING:policy:2 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=60797 PROTO=ICMP TYPE=0 CODE=0 ID=39 SEQ=2 [ 275.431901] TRACE: mangle:PREROUTING:policy:1 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=60797 PROTO=ICMP TYPE=0 CODE=0 ID=39 SEQ=2 å™«â€¦ æ–­åœ¨äº† mangle è¡¨çš„ PREROUTING å’Œ FORWARD ä¸¤æ¡é“¾ä¹‹é—´. iptables -t mangle -nLâ€¦\nChain PREROUTING (policy ACCEPT) target prot opt source destination Chain INPUT (policy ACCEPT) target prot opt source destination Chain FORWARD (policy ACCEPT) target prot opt source destination Chain OUTPUT (policy ACCEPT) target prot opt source destination Chain POSTROUTING (policy ACCEPT) target prot opt source destination å•Šâ€¦ (æ©é¢)\nå®Œå…¨æ­£å¸¸çš„ iptables å’Œ IPv4 è·¯ç”± æˆ‘ç¼–è¯‘äº†å¾ˆå¤šæ¬¡å†…æ ¸, æ‰“å‡ºæ›´å¤šçš„è°ƒè¯•ä¿¡æ¯, åˆ°æ„è¯†åˆ°çœŸæ­£é—®é¢˜ä¸ºæ­¢æˆ‘åšäº†å¦‚ä¸‹çš„æ”¹åŠ¨:\ndiff -ur a/net/ipv4/ip_input.c b/net/ipv4/ip_input.c --- a/net/ipv4/ip_input.c\t2015-10-31 17:10:54.000000000 +0800 +++ b/net/ipv4/ip_input.c\t2015-11-05 10:48:11.713066532 +0800 @@ -341,6 +341,8 @@ if (!skb_dst(skb)) { int err = ip_route_input_noref(skb, iph-\u003edaddr, iph-\u003esaddr, iph-\u003etos, skb-\u003edev); +\tif (unlikely(skb-\u003enf_trace)) +\tpr_info(\"ip_rcv_finish: ip_route_noref=%d\\n\", err); if (unlikely(err)) { if (err == -EXDEV) NET_INC_STATS_BH(dev_net(skb-\u003edev), @@ -349,6 +351,9 @@ } } +\tif (unlikely(skb-\u003enf_trace)) +\tpr_info(\"ip_rcv_finish: survived routing\\n\"); + #ifdef CONFIG_IP_ROUTE_CLASSID if (unlikely(skb_dst(skb)-\u003etclassid)) { struct ip_rt_acct *st = this_cpu_ptr(ip_rt_acct); @@ -374,6 +379,9 @@ return dst_input(skb); drop: +\tif (unlikely(skb-\u003enf_trace)) +\tpr_info(\"ip_rcv_finish: whoops\\n\"); + kfree_skb(skb); return NET_RX_DROP; } diff -ur a/net/ipv4/netfilter/iptable_mangle.c b/net/ipv4/netfilter/iptable_mangle.c --- a/net/ipv4/netfilter/iptable_mangle.c\t2015-08-31 02:34:09.000000000 +0800 +++ b/net/ipv4/netfilter/iptable_mangle.c\t2015-11-05 10:48:11.692066533 +0800 @@ -61,6 +61,8 @@ ret = ipt_do_table(skb, NF_INET_LOCAL_OUT, state, dev_net(out)-\u003eipv4.iptable_mangle); +\tif (unlikely(skb-\u003enf_trace)) +\tpr_info(\"ipt_mangle_out: ipt_do_table=%d\\n\", ret); /* Reroute for ANY change. */ if (ret != NF_DROP \u0026\u0026 ret != NF_STOLEN) { iph = ip_hdr(skb); @@ -70,6 +72,8 @@ skb-\u003emark != mark || iph-\u003etos != tos) { err = ip_route_me_harder(skb, RTN_UNSPEC); +\tif (unlikely(skb-\u003enf_trace)) +\tpr_info(\"ipt_mangle_out: ip_route_me_harder=%d\\n\", err); if (err \u003c 0) ret = NF_DROP_ERR(err); } @@ -84,14 +88,28 @@ struct sk_buff *skb, const struct nf_hook_state *state) { -\tif (ops-\u003ehooknum == NF_INET_LOCAL_OUT) -\treturn ipt_mangle_out(skb, state); -\tif (ops-\u003ehooknum == NF_INET_POST_ROUTING) -\treturn ipt_do_table(skb, ops-\u003ehooknum, state, +\tint phase; +\tunsigned int ret; +\tif (ops-\u003ehooknum == NF_INET_LOCAL_OUT) { +\tphase = 0; +\tret = ipt_mangle_out(skb, state); +\tgoto out; +\t} +\tif (ops-\u003ehooknum == NF_INET_POST_ROUTING) { +\tphase = 1; +\tret = ipt_do_table(skb, ops-\u003ehooknum, state, dev_net(state-\u003eout)-\u003eipv4.iptable_mangle); +\tgoto out; +\t} /* PREROUTING/INPUT/FORWARD: */ -\treturn ipt_do_table(skb, ops-\u003ehooknum, state, +\tphase = 2; +\tret = ipt_do_table(skb, ops-\u003ehooknum, state, dev_net(state-\u003ein)-\u003eipv4.iptable_mangle); + +\tout: +\tif (unlikely(skb-\u003enf_trace)) +\tpr_info(\"iptable_mangle_hook: phase=%d ret=%u\\n\", phase, ret); +\treturn ret; } static struct nf_hook_ops *mangle_ops __read_mostly; diff -ur a/net/ipv4/netfilter/ip_tables.c b/net/ipv4/netfilter/ip_tables.c --- a/net/ipv4/netfilter/ip_tables.c\t2015-10-31 17:10:54.000000000 +0800 +++ b/net/ipv4/netfilter/ip_tables.c\t2015-11-05 10:48:11.690066533 +0800 @@ -429,6 +429,9 @@ xt_write_recseq_end(addend); local_bh_enable(); +\tif (unlikely(skb-\u003enf_trace)) +\tpr_info(\"TRACE: acpar.hotdrop=%d verdict=%d\\n\", acpar.hotdrop, verdict); + #ifdef DEBUG_ALLOW_ALL return NF_ACCEPT; #else ç„¶åé‡å¯è¿›ä¿®æ”¹è¿‡çš„å†…æ ¸, ç»™ ICMP åŒ…å¯ç”¨è·Ÿè¸ª, çœ‹åˆ°äº†è¿™æ ·çš„ç»“æœ:\n[ 89.207465] TRACE: raw:PREROUTING:policy:2 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=255 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25 [ 89.209365] ip_tables: TRACE: acpar.hotdrop=0 verdict=1 [ 89.210310] TRACE: mangle:PREROUTING:policy:1 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=255 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25 [ 89.212222] ip_tables: TRACE: acpar.hotdrop=0 verdict=1 [ 89.213162] iptable_mangle_hook: phase=2 ret=1 [ 89.214087] IPv4: ip_rcv_finish: ip_route_noref=0 [ 89.214994] IPv4: ip_rcv_finish: survived routing [ 89.215891] TRACE: mangle:FORWARD:policy:1 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25 [ 89.217741] ip_tables: TRACE: acpar.hotdrop=0 verdict=1 [ 89.218679] iptable_mangle_hook: phase=2 ret=1 [ 89.219605] TRACE: filter:FORWARD:rule:1 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25 [ 89.221493] TRACE: filter:DOCKER:return:2 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25 [ 89.223402] TRACE: filter:FORWARD:rule:2 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25 [ 89.225315] ip_tables: TRACE: acpar.hotdrop=0 verdict=1 [ 89.226257] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=docker0 SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25 [ 89.228144] ip_tables: TRACE: acpar.hotdrop=0 verdict=1 [ 89.229073] iptable_mangle_hook: phase=1 ret=1 å’Œ\n[ 90.209849] TRACE: raw:PREROUTING:policy:2 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=255 ID=47321 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=26 [ 90.212000] ip_tables: TRACE: acpar.hotdrop=0 verdict=1 [ 90.212974] TRACE: mangle:PREROUTING:policy:1 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=255 ID=47321 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=26 [ 90.214932] ip_tables: TRACE: acpar.hotdrop=0 verdict=1 [ 90.215900] iptable_mangle_hook: phase=2 ret=1 [ 90.216854] IPv4: ip_rcv_finish: ip_route_noref=0 [ 90.217795] IPv4: ip_rcv_finish: survived routing æˆ‘æ“¦æ³ªâ€¦ è¿™è·¯ç”±ç»“æœæ˜æ˜æ˜¯å¯¹çš„â€¦ iptables ä¹Ÿæ­£ç¡®æ”¾è¡Œäº†â€¦ é‚£ä¸ºä½•æ²¡æœ‰ forward å‘¢?\næœ€åçŸ¥é“çœŸç›¸çš„æˆ‘çœ¼æ³ªæ‰ä¸‹æ¥ diff -ur a/net/ipv4/route.c b/net/ipv4/route.c --- a/net/ipv4/route.c\t2015-10-31 17:10:54.000000000 +0800 +++ b/net/ipv4/route.c\t2015-11-05 10:48:11.713066532 +0800 @@ -1717,11 +1717,15 @@ fl4.daddr = daddr; fl4.saddr = saddr; err = fib_lookup(net, \u0026fl4, \u0026res, 0); +\tif (unlikely(skb-\u003enf_trace)) +\tpr_info(\"ip_route_input_slow: fib_lookup err=%d IN_DEV_FORWARD(in_dev)=%d\\n\", err, IN_DEV_FORWARD(in_dev)); if (err != 0) { if (!IN_DEV_FORWARD(in_dev)) err = -EHOSTUNREACH; goto no_route; } +\tif (unlikely(skb-\u003enf_trace)) +\tpr_info(\"ip_route_input_slow: res.type=%d\\n\", res.type); if (res.type == RTN_BROADCAST) goto brd_input; @@ -1741,6 +1745,9 @@ if (res.type != RTN_UNICAST) goto martian_destination; +\tif (unlikely(skb-\u003enf_trace)) +\tpr_info(\"ip_route_input_slow: passed!\\n\"); + err = ip_mkroute_input(skb, \u0026res, \u0026fl4, in_dev, daddr, saddr, tos); out:\treturn err; å…¶å®åœ¨å†™å®Œè¿™ä¸ªæ›´æ”¹ä¹‹åæˆ‘å·²ç»æ„è¯†åˆ°é—®é¢˜äº†, å› ä¸ºæˆ‘ä¸­é—´æœç´¢äº†å¾ˆå¤šå†…å®¹, å…¶ä¸­åŒ…æ‹¬è§‚å¯Ÿåˆ° /proc/net/snmp é‡Œ InAddrErrors ä¼šéšç€ä¸¢æ‰çš„åŒ…æ•°é‡å¢åŠ , è€Œè¿™ä¸ªé‡å¯¹åº”çš„å†…æ ¸çŠ¶æ€ IPSTATS_MIB_INADDRERRORS åªåœ¨ä¸€ä¸ªåœ°æ–¹å¢åŠ :\n/* net/ipv4/route.c */ static int ip_error(struct sk_buff *skb) { struct in_device *in_dev = __in_dev_get_rcu(skb-\u003edev); struct rtable *rt = skb_rtable(skb); struct inet_peer *peer; unsigned long now; struct net *net; bool send; int code; /* IP on this device is disabled. */ if (!in_dev) goto out; net = dev_net(rt-\u003edst.dev); if (!IN_DEV_FORWARD(in_dev)) { switch (rt-\u003edst.error) { case EHOSTUNREACH: IP_INC_STATS_BH(net, IPSTATS_MIB_INADDRERRORS); break; case ENETUNREACH: IP_INC_STATS_BH(net, IPSTATS_MIB_INNOROUTES); break; } goto out; } /* ... */ out: kfree_skb(skb); return 0; } å—¯â€¦ è¿™è¯´æ˜ IN_DEV_FORWARD(in_dev) å¿…ç„¶ä¸ºå‡, å°±æ˜¯è¯´ /proc/sys/net/ipv4/conf/xxx/forwarding å±…ç„¶ä¸æ˜¯ 1? æˆ‘ä¹‹å‰ä¸ç›¸ä¿¡è¿™ä¸ªå¯èƒ½æ€§, æ‰€ä»¥æ‰“äº†å¾ˆå¤šæ—¥å¿—, ä½†æ˜¯ç°åœ¨çœ‹æ¥çœŸç›¸åªæœ‰ä¸€ä¸ªäº†! å› ä¸ºè°ƒè¯•çš„æ—¶å€™è§‚å¯Ÿåˆ°åªè¦ä¸€è¿è¡Œ tcpdump å®¹å™¨å°±ä¼šæ–­ç½‘, æˆ‘å°±é‡å¯æœºå™¨ç®€å•æµ‹è¯•äº†ä¸€ä¸‹:\n# cat /proc/sys/net/ipv4/conf/eno1/forwarding 1 # tcpdump -i docker0 -s 65535 -w 111.pcap (...) ^C # cat /proc/sys/net/ipv4/conf/eno1/forwarding 0 ç»™æˆ‘å—è±†è…â€¦ é‚£é™¤äº†å†…æ ¸, è¿˜ä¼šæœ‰è°å…³å¿ƒç½‘ç»œç•Œé¢çš„å‚æ•°è®¾ç½®å‘¢? å¾ˆå®¹æ˜“å°±èƒ½è”æƒ³åˆ° systemd-networkd äº†â€¦ æœç„¶åœ¨ man systemd.network é‡Œå¯¹äº IPForward å‚æ•°æœ‰è¯´æ˜:\nNote: unless this option is turned on, or set to \"kernel\", no IP forwarding is done on this interface, even if this is globally turned on in the kernel, with the net.ipv4.ip_forward, net.ipv4.conf.all.forwarding, and net.ipv6.conf.all.forwarding sysctl options.\n(æ ¼å¼æ˜¯æˆ‘åŠ ä¸Šçš„, æ–¹ä¾¿é˜…è¯»)\näºæ˜¯åšäº†å¼€å¤´çš„ one-line fix, é‡å¯, é—®é¢˜æ¶ˆå¤±. å‰åèŠ±æ‰äº† 3 å¤©æ—¶é—´æ€è€ƒå’Œè°ƒè¯•. çœ‹èµ·æ¥ç”Ÿäº§ç¯å¢ƒç”¨ä¸Š systemd-networkd çš„äººä¸å¤šå•Šâ€¦ å¦åˆ™æ€ä¹ˆå¯èƒ½è‡³ä»Šæ²¡æœ‰æ–‡ç« ä»‹ç»è¿™ä¸ªå‘å‘¢?\nè¿½è®°: ä¸å®šæœŸæ–­ç½‘çš„åŸå› è¿½è¸ª è§£å†³äº†æ–­ç½‘é—®é¢˜ä¹‹å, æˆ‘ç»§ç»­æ€è€ƒäº†ä¸€ä¸‹ä¸ºä»€ä¹ˆ systemd-networkd ä¼šä¸å®šæœŸè·Ÿå†…æ ¸åŒæ­¥. ç¨å¾®ç†Ÿæ‚‰ä¸€ç‚¹ systemd çš„å„ä½éƒ½çŸ¥é“, systemd ä¸¥é‡ä¾èµ–äº‹ä»¶é©±åŠ¨, é‚£ä¹ˆåŸå› åº”è¯¥å°±æ˜¯æœ‰äº‹ä»¶è§¦å‘äº† systemd-networkd çš„çŠ¶æ€åŒæ­¥ä»£ç . åœ¨ systemd æºç é‡Œç®€å• grep äº†ä¸€åœˆ, æœç„¶: link_set_ipv4_forward (å’Œå¦ä¸€ä¸ªè´Ÿè´£ IPv6 çš„å‡½æ•°) åªä¼šè¢« link_configure è°ƒç”¨, åˆåªä¼šè¢« link_initialized_and_synced è°ƒç”¨, åˆåªä¼šè¢« link_initialized è°ƒç”¨, è¿™ä¸ªå‡½æ•°ä¸æ˜¯ static çš„æ‰€ä»¥åº”è¯¥æœ‰åˆ«çš„åœ°æ–¹å»è°ƒç”¨å®ƒäº†, å¾ˆå¯èƒ½æ˜¯ä¸ª uevent ç›‘å¬å¾ªç¯. å› ä¸ºæ¯”èµ·ç ”ç©¶ systemd æˆ‘è¿˜æœ‰æ›´æœ‰æ„æ€çš„äº‹æƒ…è¦åš (æ¯”å¦‚å¥½å¥½æŠ˜è…¾ä¸€ä¸‹ Docker ä¹‹ç±»çš„), å°±æ²¡æœ‰ç»§ç»­æŒ–æ˜ä¸‹å»äº†, è€Œæ˜¯å†™äº†è¿™ç¯‡åˆ†ææ–‡ç« . å¸Œæœ›å¯¹å„ä½éƒ½æœ‰å¸®åŠ©!\n","wordCount":"2764","inLanguage":"zh-cmn-hans-cn","datePublished":"2015-11-05T15:45:00+08:00","dateModified":"2015-11-05T15:45:00+08:00","author":[{"@type":"Person","name":"WÃNG \"xen0n\" XuÄ›ruÃ¬"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.xen0n.name/posts/tinkering/docker-systemd-networkd-frustrations/"},"publisher":{"@type":"Organization","name":"write(2)","logo":{"@type":"ImageObject","url":"https://blog.xen0n.name/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.xen0n.name/ accesskey=h title="write(2) (Alt + H)">write(2)</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.xen0n.name/en/ title="English (US)" aria-label=:us:>ğŸ‡ºğŸ‡¸</a></li></ul></span></div><ul id=menu><li><a href=https://blog.xen0n.name/archives title=æ‰€æœ‰æ–‡ç« ><span>æ‰€æœ‰æ–‡ç« </span></a></li><li><a href=https://blog.xen0n.name/%E6%96%87%E7%AB%A0%E7%B1%BB%E5%88%AB title=æ–‡ç« ç±»åˆ«><span>æ–‡ç« ç±»åˆ«</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.xen0n.name/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://blog.xen0n.name/posts/>Posts</a></div><h1 class=post-title>Docker ä¸ systemd-networkd ä¹‹é—´ä¸å¾—ä¸è¯´çš„æ•…äº‹</h1><div class=post-meta><span title='2015-11-05 15:45:00 +0800 +0800'>2015/11/05</span>&nbsp;Â·&nbsp;é¢„è®¡é˜…è¯»æ—¶é—´: 6 åˆ†é’Ÿ&nbsp;Â·&nbsp;WÃNG "xen0n" XuÄ›ruÃ¬</div></header><div class=post-content><h2 id=tldr>tl;dr<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>å¦‚æœä½ <strong>ä½¿ç”¨ systemd-networkd ç®¡ç†ä½ çš„ç½‘ç»œç•Œé¢</strong>, åˆæŠŠè¿™å°æœºå™¨ä½œä¸º <strong>Docker å®¹å™¨å®¿ä¸»</strong>çš„è¯,
é‚£ä½ å¾ˆå¯èƒ½ä¼šå‘ç°ä½ çš„å®¹å™¨è¿‡ä¸€æ®µæ—¶é—´å°±ä¼šä¸èƒ½è®¿é—®å¤–ç½‘. ä½ éœ€è¦åœ¨ <code>/etc/systemd/network/your.network</code>
é…ç½®é‡Œæ˜ç¡®å‘Šè¯‰ systemd-networkd å¼€å¯æŠ¥æ–‡è½¬å‘:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Network]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>IPForward</span><span style=color:#f92672>=</span><span style=color:#e6db74>yes</span>
</span></span></code></pre></div><h2 id=å¹¶ä¸æ„‰å¿«çš„ç»å†>å¹¶ä¸æ„‰å¿«çš„ç»å†<a hidden class=anchor aria-hidden=true href=#å¹¶ä¸æ„‰å¿«çš„ç»å†>#</a></h2><p>æˆ‘æœ‰ä¸€å°æ‰“ç®—åš Docker å®¹å™¨å®¿ä¸»çš„æœåŠ¡å™¨, ç„¶è€Œéƒ¨ç½²å®Œæˆä¸ä¹…å°±å‘ç°äº†ä¸€ä¸ªä¸¥é‡é—®é¢˜ &ndash;
å®¹å™¨ä¸èƒ½è®¿é—®å¤–ç½‘! å¥½å§å®é™…ä¸Šè¿˜æ˜¯å¯ä»¥çš„&mldr; åˆšå¼€æœºå°±å¯åŠ¨çš„ Docker å®¹å™¨å¯ä»¥è”ç½‘,
è¿‡ä¸€ä¼šå¯åŠ¨çš„å®¹å™¨ä¹Ÿèƒ½, ä½†å†è¿‡ä¸€ä¼šå°±ä¸è¡Œäº†; æ•…éšœæ—¶é—´ä¹Ÿä¸ä¸€å®š, æœ‰æ—¶å€™å¼€æœºå‡ åˆ†é’Ÿå°±æ–­ç½‘äº†,
æœ‰æ—¶å€™èƒ½æ’‘åŠä¸ªå°æ—¶, å®Œå…¨æ²¡æœ‰è§„å¾‹. å°±è¿™æ ·é—²ç½®äº†åŠå¹´ä¹‹ä¹…!</p><p>æœ€è¿‘å› ä¸ºåšé¡¹ç›®, åˆæœ‰äº†ç”¨å®¹å™¨çš„éœ€æ±‚, å°±æƒ³ç€å›æ¥è°ƒè¯•ä¸€ä¸‹å§; æ›´æ–°äº†æ‰€æœ‰è½¯ä»¶åˆ°æœ€æ–°ç‰ˆæœ¬,
ä¹Ÿå‡çº§äº†å†…æ ¸åˆ°æœ€æ–°çš„ Gentoo Hardened 4.2.5 ç‰ˆæœ¬, ç„¶è€Œæƒ…å†µå¹¶æ²¡æœ‰å˜åŒ–.
å› ä¸ºåˆšåˆšé—²äº†ä¸‹æ¥, å°±å½»å½»åº•åº•åœ°è§£å†³è¿™ä¸ªé—®é¢˜å¥½äº†, äºæ˜¯æˆ‘æ‰“å¼€äº†å†…æ ¸æºç  ;-)</p><h2 id=æ­£å¸¸çš„æµé‡>æ­£å¸¸çš„æµé‡<a hidden class=anchor aria-hidden=true href=#æ­£å¸¸çš„æµé‡>#</a></h2><p>ä¹‹å‰å°±åœ¨æœºå™¨ä¸ŠæŠ“è¿‡ä¸€æ¬¡åŒ…, æƒ³çœ‹çœ‹ä¸ºä»€ä¹ˆå®¹å™¨æ²¡æœ‰æ”¶åˆ°å“åº”. å› ä¸ºæ–­ç½‘çš„åŸå› æ˜¯å¤šç§å¤šæ ·çš„,
å¯èƒ½æ˜¯æŠ¥æ–‡æ²¡æœ‰å‡º <code>docker0</code> ç•Œé¢, æŠ¥æ–‡æ²¡æœ‰ä¸Šåˆ°ç‰©ç†ç•Œé¢, æŠ¥æ–‡æ²¡æœ‰æ­£ç¡®è¢« NAT å›
Docker å†…ç½‘åœ°å€, è¿˜å¯èƒ½æ˜¯å…¶ä»–æ›´ç¥å¥‡çš„åŸå› . æˆ‘åœ¨å®¹å™¨é‡Œ ping å®¿ä¸»çš„ç½‘å…³å’Œ DNS
æœåŠ¡å™¨, åœ¨å®¿ä¸»ä¸ŠæŠ“åŒ…, ç„¶è€Œçœ‹åˆ°ç»“æœä¹‹åæˆ‘å‡ ä¹ç–¯æ‰äº†&mldr;</p><p>ç‰©ç†ç•Œé¢ä¸Šæœ‰å®Œæ•´çš„ ICMP Ping è¯·æ±‚å’Œå“åº”åŒ…, ç„¶è€Œ <code>docker0</code> ä¸Šçš„å“åº”è¢«åƒæ‰äº†!</p><p>æˆ‘åˆé€šè¿‡æ‹¼æ‰‹é€Ÿ, è®¾æ³•æŠ“åˆ°äº†æ–­ç½‘ä¸€ç¬é—´å‰åçš„ç½‘ç»œæµé‡, ä»ç„¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜;
åœ¨æŸä¸ªæ—¶é—´ç‚¹è¿‡å, å“åº”åŒ…å°±æ˜¯æ¶ˆå¤±äº†, å®Œå…¨ä¸è®²é“ç†. æˆ‘è§‰å¾—é—®é¢˜å¯èƒ½å‡ºåœ¨ Linux å†…æ ¸æœ¬èº«äº†.</p><h2 id=ä»ç„¶æ­£å¸¸çš„-iptables>ä»ç„¶æ­£å¸¸çš„ iptables<a hidden class=anchor aria-hidden=true href=#ä»ç„¶æ­£å¸¸çš„-iptables>#</a></h2><p>Docker é»˜è®¤çš„å®¹å™¨è”ç½‘æ–¹å¼æ˜¯æ¡¥æ¥ç½‘ç»œ, å°±æ˜¯:</p><ul><li>Docker å¯åŠ¨æ—¶åˆå§‹åŒ–ä¸€ä¸ªç½‘æ¡¥ <code>docker0</code>, è®¾ç½® iptables è®©é¢„å…ˆé…ç½®çš„ Docker ç½‘æ®µèƒ½ NAT åˆ°å¤–ç½‘</li><li>å®¹å™¨å¯åŠ¨æ—¶, é¦–å…ˆåˆ›å»ºä¸€å¯¹ <code>vethXXXXXX</code> è™šæ‹Ÿç•Œé¢, ä¸€ç«¯å¡è¿›å®¹å™¨çš„ netns é‡Œ, ä¸€ç«¯ç•™åœ¨å®¿ä¸»</li><li>ç„¶åæŠŠå®¿ä¸»ä¸€ä¾§çš„ veth ç•Œé¢æ¥å…¥ <code>docker0</code></li><li>å¦‚æœæœ‰è®¾ç½®ç«¯å£æ˜ å°„çš„è¯, å°±ä¸ºå¯¹åº”çš„å®¹å™¨ IP å’Œç«¯å£è®¾ç½® <code>MASQUERADE</code> å’Œ <code>DNAT</code></li></ul><p>å…·ä½“æƒ…å†µå„ä½å¯ä»¥è‡ªè¡Œåœ¨è·‘ Docker çš„æœºå™¨ä¸Šçœ‹ä¸€çœ‹ <code>iptables -nvL</code> å’Œ <code>iptables -t nat -nvL</code>
çš„è¾“å‡º, ä¸è¿‡åº”è¯¥åŒºåˆ«ä¸å¤§.</p><p>å› ä¸ºä¸¢åŒ…çš„è¯é¦–å…ˆå°±æ˜¯è€ƒè™‘ iptables æ˜¯ä¸æ˜¯æŠŠåŒ…ç»™ <code>DROP</code> äº†, æˆ‘æ˜¾ç„¶ä¹Ÿæ˜¯æ£€æŸ¥äº†ä¸€ä¸‹,
ç„¶è€Œ <code>DROP</code> ä¸€æ¬¡éƒ½æ²¡æœ‰å‡ºç°&mldr; (å› ä¸ºæœåŠ¡å™¨æ‰˜ç®¡åœ¨å­¦æ ¡ç½‘ç»œä¸­å¿ƒ, æˆ‘æš‚æ—¶æ²¡æœ‰å•ç‹¬è®¾ç½®é˜²ç«å¢™)</p><p>è¿™ä¸ç§‘å­¦, å› æ­¤æˆ‘åšäº†è¿™ä¸ªæ“ä½œç»™æ‰€æœ‰ ICMP åŒ…å¯ç”¨äº†è·Ÿè¸ª:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># é¦–å…ˆéœ€è¦åŠ è½½ xt_LOG æ¨¡å—, è¿™æ · TRACE æ‰æœ‰æ•ˆ, å®é™…ä¸Š modprobe xt_LOG å°±è¡Œäº†</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç„¶è€Œæˆ‘ç›´æ¥æ·»åŠ äº†ä¸€æ¡è§„åˆ™, æ•ˆæœä¸€æ ·</span>
</span></span><span style=display:flex><span>iptables -t nat -I PREROUTING <span style=color:#ae81ff>1</span> -p icmp -j LOG
</span></span><span style=display:flex><span>iptables -t raw -A PREROUTING -p icmp -j TRACE
</span></span><span style=display:flex><span>iptables -t raw -A OUTPUT -p icmp -j TRACE
</span></span></code></pre></div><p>ç»§ç»­æ‹¼æ‰‹é€Ÿæ‰“å‡ºäº†æ–­ç½‘å‰åçš„ trace å¯¹æ¯” (æŠŠ IP å’Œç¡¬ä»¶åœ°å€æ‰“ç äº†, å¹¶ä¸”æ”¹äº† Docker çš„ç½‘æ®µ):</p><pre tabindex=0><code>[  118.520085] TRACE: raw:PREROUTING:policy:2 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64
[  118.520091] TRACE: mangle:PREROUTING:policy:1 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64
[  118.520097] TRACE: mangle:FORWARD:policy:1 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64
[  118.520101] TRACE: filter:FORWARD:rule:1 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64
[  118.520105] TRACE: filter:DOCKER:return:2 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64
[  118.520109] TRACE: filter:FORWARD:rule:2 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64
[  118.520112] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=docker0 SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=60758 PROTO=ICMP TYPE=0 CODE=0 ID=35 SEQ=64
</code></pre><p>å’Œ</p><pre tabindex=0><code>[  275.429990] TRACE: raw:PREROUTING:policy:2 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=60797 PROTO=ICMP TYPE=0 CODE=0 ID=39 SEQ=2
[  275.431901] TRACE: mangle:PREROUTING:policy:1 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=60797 PROTO=ICMP TYPE=0 CODE=0 ID=39 SEQ=2
</code></pre><p>å™«&mldr; æ–­åœ¨äº† <code>mangle</code> è¡¨çš„ <code>PREROUTING</code> å’Œ <code>FORWARD</code> ä¸¤æ¡é“¾ä¹‹é—´. <code>iptables -t mangle -nL</code>&mldr;</p><pre tabindex=0><code>Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination

Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
</code></pre><p>å•Š&mldr; (æ©é¢)</p><h2 id=å®Œå…¨æ­£å¸¸çš„-iptables-å’Œ-ipv4-è·¯ç”±>å®Œå…¨æ­£å¸¸çš„ iptables å’Œ IPv4 è·¯ç”±<a hidden class=anchor aria-hidden=true href=#å®Œå…¨æ­£å¸¸çš„-iptables-å’Œ-ipv4-è·¯ç”±>#</a></h2><p>æˆ‘ç¼–è¯‘äº†å¾ˆå¤šæ¬¡å†…æ ¸, æ‰“å‡ºæ›´å¤šçš„è°ƒè¯•ä¿¡æ¯, åˆ°æ„è¯†åˆ°çœŸæ­£é—®é¢˜ä¸ºæ­¢æˆ‘åšäº†å¦‚ä¸‹çš„æ”¹åŠ¨:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff -ur a/net/ipv4/ip_input.c b/net/ipv4/ip_input.c
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/net/ipv4/ip_input.c	2015-10-31 17:10:54.000000000 +0800
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/net/ipv4/ip_input.c	2015-11-05 10:48:11.713066532 +0800
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -341,6 +341,8 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 	if (!skb_dst(skb)) {
</span></span><span style=display:flex><span> 		int err = ip_route_input_noref(skb, iph-&gt;daddr, iph-&gt;saddr,
</span></span><span style=display:flex><span> 					       iph-&gt;tos, skb-&gt;dev);
</span></span><span style=display:flex><span><span style=color:#a6e22e>+		if (unlikely(skb-&gt;nf_trace))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+			pr_info(&#34;ip_rcv_finish: ip_route_noref=%d\n&#34;, err);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 		if (unlikely(err)) {
</span></span><span style=display:flex><span> 			if (err == -EXDEV)
</span></span><span style=display:flex><span> 				NET_INC_STATS_BH(dev_net(skb-&gt;dev),
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -349,6 +351,9 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 		}
</span></span><span style=display:flex><span> 	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+	if (unlikely(skb-&gt;nf_trace))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		pr_info(&#34;ip_rcv_finish: survived routing\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> #ifdef CONFIG_IP_ROUTE_CLASSID
</span></span><span style=display:flex><span> 	if (unlikely(skb_dst(skb)-&gt;tclassid)) {
</span></span><span style=display:flex><span> 		struct ip_rt_acct *st = this_cpu_ptr(ip_rt_acct);
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -374,6 +379,9 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 	return dst_input(skb);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> drop:
</span></span><span style=display:flex><span><span style=color:#a6e22e>+	if (unlikely(skb-&gt;nf_trace))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		pr_info(&#34;ip_rcv_finish: whoops\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 	kfree_skb(skb);
</span></span><span style=display:flex><span> 	return NET_RX_DROP;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>diff -ur a/net/ipv4/netfilter/iptable_mangle.c b/net/ipv4/netfilter/iptable_mangle.c
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/net/ipv4/netfilter/iptable_mangle.c	2015-08-31 02:34:09.000000000 +0800
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/net/ipv4/netfilter/iptable_mangle.c	2015-11-05 10:48:11.692066533 +0800
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -61,6 +61,8 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> 	ret = ipt_do_table(skb, NF_INET_LOCAL_OUT, state,
</span></span><span style=display:flex><span> 			   dev_net(out)-&gt;ipv4.iptable_mangle);
</span></span><span style=display:flex><span><span style=color:#a6e22e>+	if (unlikely(skb-&gt;nf_trace))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		pr_info(&#34;ipt_mangle_out: ipt_do_table=%d\n&#34;, ret);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 	/* Reroute for ANY change. */
</span></span><span style=display:flex><span> 	if (ret != NF_DROP &amp;&amp; ret != NF_STOLEN) {
</span></span><span style=display:flex><span> 		iph = ip_hdr(skb);
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -70,6 +72,8 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 		    skb-&gt;mark != mark ||
</span></span><span style=display:flex><span> 		    iph-&gt;tos != tos) {
</span></span><span style=display:flex><span> 			err = ip_route_me_harder(skb, RTN_UNSPEC);
</span></span><span style=display:flex><span><span style=color:#a6e22e>+			if (unlikely(skb-&gt;nf_trace))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+				pr_info(&#34;ipt_mangle_out: ip_route_me_harder=%d\n&#34;, err);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 			if (err &lt; 0)
</span></span><span style=display:flex><span> 				ret = NF_DROP_ERR(err);
</span></span><span style=display:flex><span> 		}
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -84,14 +88,28 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 		     struct sk_buff *skb,
</span></span><span style=display:flex><span> 		     const struct nf_hook_state *state)
</span></span><span style=display:flex><span> {
</span></span><span style=display:flex><span><span style=color:#f92672>-	if (ops-&gt;hooknum == NF_INET_LOCAL_OUT)
</span></span></span><span style=display:flex><span><span style=color:#f92672>-		return ipt_mangle_out(skb, state);
</span></span></span><span style=display:flex><span><span style=color:#f92672>-	if (ops-&gt;hooknum == NF_INET_POST_ROUTING)
</span></span></span><span style=display:flex><span><span style=color:#f92672>-		return ipt_do_table(skb, ops-&gt;hooknum, state,
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+	int phase;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	unsigned int ret;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	if (ops-&gt;hooknum == NF_INET_LOCAL_OUT) {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		phase = 0;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		ret = ipt_mangle_out(skb, state);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		goto out;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	if (ops-&gt;hooknum == NF_INET_POST_ROUTING) {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		phase = 1;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		ret = ipt_do_table(skb, ops-&gt;hooknum, state,
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 				    dev_net(state-&gt;out)-&gt;ipv4.iptable_mangle);
</span></span><span style=display:flex><span><span style=color:#a6e22e>+		goto out;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 	/* PREROUTING/INPUT/FORWARD: */
</span></span><span style=display:flex><span><span style=color:#f92672>-	return ipt_do_table(skb, ops-&gt;hooknum, state,
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+	phase = 2;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	ret = ipt_do_table(skb, ops-&gt;hooknum, state,
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 			    dev_net(state-&gt;in)-&gt;ipv4.iptable_mangle);
</span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	out:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	if (unlikely(skb-&gt;nf_trace))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		pr_info(&#34;iptable_mangle_hook: phase=%d ret=%u\n&#34;, phase, ret);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+	return ret;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> static struct nf_hook_ops *mangle_ops __read_mostly;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>diff -ur a/net/ipv4/netfilter/ip_tables.c b/net/ipv4/netfilter/ip_tables.c
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/net/ipv4/netfilter/ip_tables.c	2015-10-31 17:10:54.000000000 +0800
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/net/ipv4/netfilter/ip_tables.c	2015-11-05 10:48:11.690066533 +0800
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -429,6 +429,9 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  	xt_write_recseq_end(addend);
</span></span><span style=display:flex><span>  	local_bh_enable();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+	if (unlikely(skb-&gt;nf_trace))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		pr_info(&#34;TRACE: acpar.hotdrop=%d verdict=%d\n&#34;, acpar.hotdrop, verdict);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> #ifdef DEBUG_ALLOW_ALL
</span></span><span style=display:flex><span> 	return NF_ACCEPT;
</span></span><span style=display:flex><span> #else
</span></span></code></pre></div><p>ç„¶åé‡å¯è¿›ä¿®æ”¹è¿‡çš„å†…æ ¸, ç»™ ICMP åŒ…å¯ç”¨è·Ÿè¸ª, çœ‹åˆ°äº†è¿™æ ·çš„ç»“æœ:</p><pre tabindex=0><code>[   89.207465] TRACE: raw:PREROUTING:policy:2 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=255 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25
[   89.209365] ip_tables: TRACE: acpar.hotdrop=0 verdict=1
[   89.210310] TRACE: mangle:PREROUTING:policy:1 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=255 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25
[   89.212222] ip_tables: TRACE: acpar.hotdrop=0 verdict=1
[   89.213162] iptable_mangle_hook: phase=2 ret=1
[   89.214087] IPv4: ip_rcv_finish: ip_route_noref=0
[   89.214994] IPv4: ip_rcv_finish: survived routing
[   89.215891] TRACE: mangle:FORWARD:policy:1 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25
[   89.217741] ip_tables: TRACE: acpar.hotdrop=0 verdict=1
[   89.218679] iptable_mangle_hook: phase=2 ret=1
[   89.219605] TRACE: filter:FORWARD:rule:1 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25
[   89.221493] TRACE: filter:DOCKER:return:2 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25
[   89.223402] TRACE: filter:FORWARD:rule:2 IN=eno1 OUT=docker0 MAC=xxx SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25
[   89.225315] ip_tables: TRACE: acpar.hotdrop=0 verdict=1
[   89.226257] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=docker0 SRC=xxx DST=10.111.1.2 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=47320 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=25
[   89.228144] ip_tables: TRACE: acpar.hotdrop=0 verdict=1
[   89.229073] iptable_mangle_hook: phase=1 ret=1
</code></pre><p>å’Œ</p><pre tabindex=0><code>[   90.209849] TRACE: raw:PREROUTING:policy:2 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=255 ID=47321 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=26
[   90.212000] ip_tables: TRACE: acpar.hotdrop=0 verdict=1
[   90.212974] TRACE: mangle:PREROUTING:policy:1 IN=eno1 OUT= MAC=xxx SRC=xxx DST=xxx LEN=84 TOS=0x00 PREC=0x00 TTL=255 ID=47321 DF PROTO=ICMP TYPE=0 CODE=0 ID=34 SEQ=26
[   90.214932] ip_tables: TRACE: acpar.hotdrop=0 verdict=1
[   90.215900] iptable_mangle_hook: phase=2 ret=1
[   90.216854] IPv4: ip_rcv_finish: ip_route_noref=0
[   90.217795] IPv4: ip_rcv_finish: survived routing
</code></pre><p>æˆ‘æ“¦æ³ª&mldr; è¿™è·¯ç”±ç»“æœæ˜æ˜æ˜¯å¯¹çš„&mldr; iptables ä¹Ÿæ­£ç¡®æ”¾è¡Œäº†&mldr; é‚£ä¸ºä½•æ²¡æœ‰ forward å‘¢?</p><h2 id=æœ€åçŸ¥é“çœŸç›¸çš„æˆ‘çœ¼æ³ªæ‰ä¸‹æ¥>æœ€åçŸ¥é“çœŸç›¸çš„æˆ‘çœ¼æ³ªæ‰ä¸‹æ¥<a hidden class=anchor aria-hidden=true href=#æœ€åçŸ¥é“çœŸç›¸çš„æˆ‘çœ¼æ³ªæ‰ä¸‹æ¥>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff -ur a/net/ipv4/route.c b/net/ipv4/route.c
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/net/ipv4/route.c	2015-10-31 17:10:54.000000000 +0800
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/net/ipv4/route.c	2015-11-05 10:48:11.713066532 +0800
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -1717,11 +1717,15 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 	fl4.daddr = daddr;
</span></span><span style=display:flex><span> 	fl4.saddr = saddr;
</span></span><span style=display:flex><span> 	err = fib_lookup(net, &amp;fl4, &amp;res, 0);
</span></span><span style=display:flex><span><span style=color:#a6e22e>+	if (unlikely(skb-&gt;nf_trace))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		pr_info(&#34;ip_route_input_slow: fib_lookup err=%d IN_DEV_FORWARD(in_dev)=%d\n&#34;, err, IN_DEV_FORWARD(in_dev));
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 	if (err != 0) {
</span></span><span style=display:flex><span> 		if (!IN_DEV_FORWARD(in_dev))
</span></span><span style=display:flex><span> 			err = -EHOSTUNREACH;
</span></span><span style=display:flex><span> 		goto no_route;
</span></span><span style=display:flex><span> 	}
</span></span><span style=display:flex><span><span style=color:#a6e22e>+	if (unlikely(skb-&gt;nf_trace))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		pr_info(&#34;ip_route_input_slow: res.type=%d\n&#34;, res.type);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span> 	if (res.type == RTN_BROADCAST)
</span></span><span style=display:flex><span> 		goto brd_input;
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -1741,6 +1745,9 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 	if (res.type != RTN_UNICAST)
</span></span><span style=display:flex><span> 		goto martian_destination;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+	if (unlikely(skb-&gt;nf_trace))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+		pr_info(&#34;ip_route_input_slow: passed!\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 	err = ip_mkroute_input(skb, &amp;res, &amp;fl4, in_dev, daddr, saddr, tos);
</span></span><span style=display:flex><span> out:	return err;
</span></span></code></pre></div><p>å…¶å®åœ¨å†™å®Œè¿™ä¸ªæ›´æ”¹ä¹‹åæˆ‘å·²ç»æ„è¯†åˆ°é—®é¢˜äº†, å› ä¸ºæˆ‘<a href=http://serverfault.com/q/653636>ä¸­é—´</a><a href=https://lists.netfilter.org/pipermail/netfilter/2005-November/063703.html>æœç´¢äº†</a><a href=https://github.com/docker/docker/issues/15172>å¾ˆå¤š</a><a href=https://github.com/docker/docker/issues/13381>å†…å®¹</a>, å…¶ä¸­åŒ…æ‹¬è§‚å¯Ÿåˆ°
<code>/proc/net/snmp</code> é‡Œ <code>InAddrErrors</code> ä¼šéšç€ä¸¢æ‰çš„åŒ…æ•°é‡å¢åŠ , è€Œè¿™ä¸ªé‡å¯¹åº”çš„å†…æ ¸çŠ¶æ€
<code>IPSTATS_MIB_INADDRERRORS</code> åªåœ¨ä¸€ä¸ªåœ°æ–¹å¢åŠ :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* net/ipv4/route.c */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>ip_error</span>(<span style=color:#66d9ef>struct</span> sk_buff <span style=color:#f92672>*</span>skb)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> in_device <span style=color:#f92672>*</span>in_dev <span style=color:#f92672>=</span> __in_dev_get_rcu(skb<span style=color:#f92672>-&gt;</span>dev);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> rtable <span style=color:#f92672>*</span>rt <span style=color:#f92672>=</span> skb_rtable(skb);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> inet_peer <span style=color:#f92672>*</span>peer;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> now;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> net <span style=color:#f92672>*</span>net;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>bool</span> send;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> code;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* IP on this device is disabled. */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>in_dev)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        net <span style=color:#f92672>=</span> dev_net(rt<span style=color:#f92672>-&gt;</span>dst.dev);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>IN_DEV_FORWARD(in_dev)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>switch</span> (rt<span style=color:#f92672>-&gt;</span>dst.error) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> EHOSTUNREACH:
</span></span><span style=display:flex><span>                        IP_INC_STATS_BH(net, IPSTATS_MIB_INADDRERRORS);
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> ENETUNREACH:
</span></span><span style=display:flex><span>                        IP_INC_STATS_BH(net, IPSTATS_MIB_INNOROUTES);
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* ... */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>out:    kfree_skb(skb);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å—¯&mldr; è¿™è¯´æ˜ <code>IN_DEV_FORWARD(in_dev)</code> å¿…ç„¶ä¸ºå‡, å°±æ˜¯è¯´ <code>/proc/sys/net/ipv4/conf/xxx/forwarding</code>
å±…ç„¶ä¸æ˜¯ <code>1</code>? æˆ‘ä¹‹å‰ä¸ç›¸ä¿¡è¿™ä¸ªå¯èƒ½æ€§, æ‰€ä»¥æ‰“äº†å¾ˆå¤šæ—¥å¿—, ä½†æ˜¯ç°åœ¨çœ‹æ¥çœŸç›¸åªæœ‰ä¸€ä¸ªäº†!
å› ä¸ºè°ƒè¯•çš„æ—¶å€™è§‚å¯Ÿåˆ°åªè¦ä¸€è¿è¡Œ <code>tcpdump</code> å®¹å™¨å°±ä¼šæ–­ç½‘, æˆ‘å°±é‡å¯æœºå™¨ç®€å•æµ‹è¯•äº†ä¸€ä¸‹:</p><pre tabindex=0><code># cat /proc/sys/net/ipv4/conf/eno1/forwarding
1
# tcpdump -i docker0 -s 65535 -w 111.pcap
(...)
^C
# cat /proc/sys/net/ipv4/conf/eno1/forwarding
0
</code></pre><p>ç»™æˆ‘å—è±†è…&mldr; é‚£é™¤äº†å†…æ ¸, è¿˜ä¼šæœ‰è°å…³å¿ƒç½‘ç»œç•Œé¢çš„å‚æ•°è®¾ç½®å‘¢? å¾ˆå®¹æ˜“å°±èƒ½è”æƒ³åˆ°
systemd-networkd äº†&mldr; æœç„¶åœ¨ <code>man systemd.network</code> é‡Œå¯¹äº <code>IPForward</code> å‚æ•°æœ‰è¯´æ˜:</p><blockquote><p>Note: unless this option is turned on, or set to <code>"kernel"</code>, <strong>no IP forwarding
is done on this interface, even if this is globally turned on in the kernel</strong>,
with the <code>net.ipv4.ip_forward</code>, <code>net.ipv4.conf.all.forwarding</code>, and
<code>net.ipv6.conf.all.forwarding</code> sysctl options.</p></blockquote><p>(æ ¼å¼æ˜¯æˆ‘åŠ ä¸Šçš„, æ–¹ä¾¿é˜…è¯»)</p><p>äºæ˜¯åšäº†å¼€å¤´çš„ one-line fix, é‡å¯, é—®é¢˜æ¶ˆå¤±. å‰åèŠ±æ‰äº† 3 å¤©æ—¶é—´æ€è€ƒå’Œè°ƒè¯•.
çœ‹èµ·æ¥ç”Ÿäº§ç¯å¢ƒç”¨ä¸Š systemd-networkd çš„äººä¸å¤šå•Š&mldr; å¦åˆ™æ€ä¹ˆå¯èƒ½è‡³ä»Šæ²¡æœ‰æ–‡ç« ä»‹ç»è¿™ä¸ªå‘å‘¢?</p><h2 id=è¿½è®°-ä¸å®šæœŸæ–­ç½‘çš„åŸå› è¿½è¸ª>è¿½è®°: ä¸å®šæœŸæ–­ç½‘çš„åŸå› è¿½è¸ª<a hidden class=anchor aria-hidden=true href=#è¿½è®°-ä¸å®šæœŸæ–­ç½‘çš„åŸå› è¿½è¸ª>#</a></h2><p>è§£å†³äº†æ–­ç½‘é—®é¢˜ä¹‹å, æˆ‘ç»§ç»­æ€è€ƒäº†ä¸€ä¸‹ä¸ºä»€ä¹ˆ systemd-networkd ä¼šä¸å®šæœŸè·Ÿå†…æ ¸åŒæ­¥.
ç¨å¾®ç†Ÿæ‚‰ä¸€ç‚¹ systemd çš„å„ä½éƒ½çŸ¥é“, systemd ä¸¥é‡ä¾èµ–äº‹ä»¶é©±åŠ¨, é‚£ä¹ˆåŸå› åº”è¯¥å°±æ˜¯æœ‰äº‹ä»¶è§¦å‘äº†
systemd-networkd çš„çŠ¶æ€åŒæ­¥ä»£ç . åœ¨ systemd æºç é‡Œç®€å• <code>grep</code> äº†ä¸€åœˆ, <a href=https://github.com/systemd/systemd/blob/master/src/network/networkd-link.c#L1802>æœç„¶</a>:
<code>link_set_ipv4_forward</code> (å’Œå¦ä¸€ä¸ªè´Ÿè´£ IPv6 çš„å‡½æ•°) åªä¼šè¢« <code>link_configure</code> è°ƒç”¨,
åˆåªä¼šè¢« <code>link_initialized_and_synced</code> è°ƒç”¨, åˆåªä¼šè¢« <code>link_initialized</code> è°ƒç”¨,
è¿™ä¸ªå‡½æ•°ä¸æ˜¯ <code>static</code> çš„æ‰€ä»¥åº”è¯¥æœ‰åˆ«çš„åœ°æ–¹å»è°ƒç”¨å®ƒäº†, å¾ˆå¯èƒ½æ˜¯ä¸ª uevent ç›‘å¬å¾ªç¯.
å› ä¸ºæ¯”èµ·ç ”ç©¶ systemd æˆ‘è¿˜æœ‰æ›´æœ‰æ„æ€çš„äº‹æƒ…è¦åš (æ¯”å¦‚å¥½å¥½æŠ˜è…¾ä¸€ä¸‹ Docker ä¹‹ç±»çš„),
å°±æ²¡æœ‰ç»§ç»­æŒ–æ˜ä¸‹å»äº†, è€Œæ˜¯å†™äº†è¿™ç¯‡åˆ†ææ–‡ç« . å¸Œæœ›å¯¹å„ä½éƒ½æœ‰å¸®åŠ©!</p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://blog.xen0n.name/posts/old/meizu-mx4-cm/cm-12.1-userdebug-7/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>CyanogenMod for é­…æ— MX4: CM12.1 20160107 æµ‹è¯•åŒ…å‘å¸ƒ</span></a>
<a class=next href=https://blog.xen0n.name/posts/old/meizu-mx4-cm/cm-12.1-userdebug-6/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>CyanogenMod for é­…æ— MX4: CM12.1 20151022 æµ‹è¯•åŒ…å‘å¸ƒ</span></a></nav></footer><script src=https://utteranc.es/client.js repo=xen0n/xen0n.github.io issue-term=pathname label=comment theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>Â© WANG Xuerui; ä»¥ cc-by-nc-sa 4.0 æˆæƒ</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>